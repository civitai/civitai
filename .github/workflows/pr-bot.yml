name: PR Bot Analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  analyze:
    name: Analyze PR
    runs-on: ubuntu-latest
    steps:
      - name: Send to PR Bot
        run: |
          # Build the payload from GitHub context
          PAYLOAD=$(cat << 'EOF'
          ${{ toJson(github.event) }}
          EOF
          )

          # Calculate HMAC signature
          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "${{ secrets.PR_BOT_WEBHOOK_SECRET }}" | awk '{print $2}')

          # Send webhook to PR Bot
          curl -X POST "${{ secrets.PR_BOT_WEBHOOK_URL }}/webhook/github" \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Event: pull_request" \
            -H "X-Hub-Signature-256: sha256=$SIGNATURE" \
            -d "$PAYLOAD" \
            --fail-with-body \
            --max-time 30
