| [Total Time](/primary/queries) | [Average Time](/primary/queries?sort=average_time) | [Calls](/primary/queries?sort=calls) |
| --- | --- | --- |
| 1,571 min 0.2% | 826,594 ms | 114 civitai |
| ```pgsql<br>-- update collection item metrics<br>      INSERT INTO "CollectionMetric" ("collectionId", timeframe, "itemCount")<br>      SELECT<br>        "collectionId",<br>        tf.timeframe,<br>        <br>    SUM(CASE<br>      <br>      WHEN tf.timeframe = 'AllTime' THEN 1<br>      WHEN tf.timeframe = 'Year' AND "createdAt" > (NOW() - interval '365 days') THEN 1<br>      WHEN tf.timeframe = 'Month' AND "createdAt" > (NOW() - interval '30 days') THEN 1<br>      WHEN tf.timeframe = 'Week' AND "createdAt" > (NOW() - interval '7 days') THEN 1<br>      WHEN tf.timeframe = 'Day' AND "createdAt" > (NOW() - interval '1 days') THEN 1<br>      ELSE 0<br>    END)<br>   as "itemCount"<br>      FROM "CollectionItem"<br>      CROSS JOIN (SELECT unnest(enum_range(NULL::"MetricTimeframe")) AS timeframe) tf<br>      WHERE "collectionId" IN (4019,15626,17705,28046,32441,35748,40038,40945,41024,41025,41031,41180,41642,42613,50973,53601,56766,61585,62026,62147,62160,68832,73327,73617,73837,79283,79625,83797,84959,92023,93193,93306,98206,101276,101913,102078,104196,117873,121346,125376,128021,128041,129746,130028,134227,135759,137169,139192,142831,144282,145424,146707,149042,149196,153466,155967,166947,167127,171330,172301,176237,177923,177925,178515,178960,180807,184770,190645,204269,204276,243442,279625,292674,300190,300239,300583,300586,300710,300898,301257,303413,304518,304579,305111,305607,305850,307126,307199,307469,308946,309032,310136,310516,310983,311428,311537,311594,311680,311917,312140,312379,312505,314167,315332,316098,318022,318084,318923,319088,319403,319576,320382,321159,321887,322436,323301,323365,323732,325657,326690,327360,327594,328105,328770,329422,329602,330996,331060,331097,331411,331674,332135,332688,334529,334814,335027,335116,336083,337834,338557,339189,339780,341296,342048,342436,343014,344864,345285,348054,349101,349371,350695,350736,350831,351334,351829,354069,354620,357947,362231,362301,363644,364217,365597,365713,367150,368425,369939,371242,379606,386078,386184,387548,390015,390867,391488,392163,392676,394210,394799,394938,397990,399218,399856,401740,402920,403083,404015,407445,410879,411158,412055,414968,416478,417375,417640,418512,418522,418833,419204,419389,421225,422164,422560,422816,422844,424006,424196,426489,427806,427970,430482,435191,436306,436956,438687,442743,444804,444851,445850,447338,449109,449261,451203,451844,452230,454593,454837,454946,455091,456529,458629,458857,461218,464482,466117,466658,467254,468959,469551,472087,473020,474310,477370,481834,482800,482802,483303,483448,484628,485471,485626,486501,486939,487532,488129,488807,491384,492117,493288,493668,495179,495647,496141,496236,496776,496862,498867,498921,499075,501640,502661,503207,504432,506996,509427,510895,511376,517715,521776,523930,525605,527540,528707,531021,531492,533238,533434,534343,535092,535146,536951,539958,541092,544281,545353,547173,547260,547322,547808,548168,550169,553805,555396,555462,555534,556415,556491,557417,558034,561252,561779,562958,565377,566751,567555,570137,570347,571488,574337,576293,577584,579425,579815,580415,582451,582657,586636,587735,588159,589093,589185,589431,590227,593123,594042,594611,594989,597754,598448,607765,608164,610800,614967,616650,617922,621986,622218,623097,624968,626637,629579,630361,631329,631863,633737,634891,636587,639004,641613,644411,645129,645286,647571,648346,649430,651602,655370,655665,655922,660078,660278,660556,660797,666090,667478,671595,675837,675940,677664,680904,682703,686902,687304,687443,687965,694328,696714,696727,698451,701935,703533,704305,707065,708555,711746,711933,712304,713841,713954,715696,717168,718734,719327,720016,722187,725552,726410,727118,729328,729806,730396,732685,732729,733907,734617,735263,739255,741137,742492,745657,748269,748922,749882,750743,752301,752949,755345,755412,757704,759015,761410,761673,763055,763181,769069,772626,774544,776416,777349,777467,780271,780682,782783,787818,787958,788360,788427,789842,789862,790793,791117,791332,792656,798560,799474,801261,801382,802960,803054,807458,810221,810509,816114,816942,822617,824044,824614,826831,828118,829561,830836,832575,832645,835188,840054,840146,842716,849820,859488,860777,862088,867616,868011,874039,876882,877611,889807,911324,925422,940849,947734,947911,947974,947995,949702,949768,954154,960946,962115,966298,969121,971393,974954,995152,997971,1000089,1001884,1009191,1013565,1013753,1016349,1019147,1025043,1029263,1034037,1035397,1039979,1052076,1066362,1079208,1079641,1083370,1084373,1086281,1092786,1098556,1107517,1107636,1108824,1109619,1109679,1109880,1110400,1112796,1113400,1114216,1115016,1116033,1116089,1118601,1119863,1119925,1121426,1121949,1122287,1122598,1124655,1125898,1128983,1135252,1135635,1142590,1143224,1144010,1145654,1147350,1148361,1164746,1164811,1169889,1177807,1179719,1184653,1185712,1187876,1189381,1189664,1189734,1192602,1202037,1203930,1205296,1205647,1208026,1211958,1214815,1217689,1218186,1219149,1219335,1219991,1220377,1221740,1223478,1223543,1223806,1226629,1229119,1233412,1233674,1234245,1236551,1237693,1240224,1243390,1248381,1248633,1252407,1252695,1254511,1254800,1256514,1262684,1265287,1270860,1271838,1282322,1285833,1287832,1296454,1301367,1317378,1319176,1326763,1338832,1342759,1347309,1348761,1362041,1383657,1385433,1387119,1390558,1400440,1402073,1435210,1441046,1441738,1442473,1466839,1468730,1488087,1488696,1500140,1524347,1536594,1544344,1553381,1561230,1564232,1567050,1568299,1574848,1586118,1594168,1594473,1636342,1645171,1649844,1654285,1665511,1668357,1729242,1729243,1733591,1747193,1751586,1767203,1769623,1815422,1843186,1843753,1854597,1858209,1867468,1868711,1893068,1927073,1944560,1963612,1970419,1978166,2001862,2005543,2026148,2030448,2032018,2047558,2063045,2067421,2074020,2082917,2086618,2098306,2105607,2106291,2108374,2114998,2122598,2122856,2125944,2140792,2148279,2157766,2167708,2178661,2178773,2194857,2201423,2207998,2211635,2215001,2227893,2241475,2249928,2254557,2263382,2265903,2269842,2284423,2293061,2323543,2328558,2352137,2358482,2366187,2369351,2378220,2381480,2403938,2415231,2425446,2452304,2457212,2483968,2494027,2509796,2514400,2529276,2543709,2549610,2564391,2583460,2599830,2600014,2607844,2621010,2639876,2669522,2675422,2687013,2687033,2689712,2700484,2706378,2711349,2725183,2725381,2726315,2727955,2739001,2746029,2749710,2752839,2763052,2763259,2766831,2772922,2798936,2800569,2812468,2812718,2813322,2828552,2829329,2830764,2834553,2834951,2835012,2844032,2854842,2858964,2859465,2863757,2863768,2870769,2888297,2890179,2908629,2908805,2909100,2930739,2940401,2940436,2941789,2960213,2967338,2976042,2977272,3004778,3015077,3028426,3050098,3087737,3087753,3098123,3104926,3116188,3134481,3143117,3146713,3148882,3163748,3187740,3199944,3205730,3220528,3283983,3293510,3299515,3308030,3311113,3318328,3335242,3341226,3342836,3345612,3346481,3350645,3351857,3359407,3361799,3366428,3395608,3401772,3418616,3418967,3435791,3445141,3467157,3496832,3499778,3518418,3531917,3532077,3534715,3535083,3545278,3556384,3557716,3559715,3561188,3565607,3587574,3614087,3616410,3617387,3624383,3626630,3628277,3629084,3648208,3650445,3656805,3658753,3667204,3669798,3669987,3682561,3700323,3706879,3737260,3742899,3760304,3789820,3791845,3792788,3793745,3795924,3812252,3822252,3837169,3838829,3850259,3850912,3855102,3865375,3870938,3875924,3882039,3909351,3921865,3932257,3940310,3944789,3951752,4038311,4052506,4065059,4068107,4073687,4080183,4091938,4101686,4105407,4112730,4114212,4116362,4142174,4176910,4233145,4239192,4252667,4283988,4290059,4301999,4304709,4307993,4333052,4336498,4365855,4369115,4394661,4406318,4420510,4423329,4432997,4439318,4444447,4464207,4471912,4490880,4502845,4560598,4568331,4569344,4593220,4595315,4612226,4616584,4618398,4628311,4633194,4641634,4666197,4741884,4755189,4756079,4757677,4764607,4771141,4772508,4777487,4788740,4811914,4812270,4822376,4836124,4863473,4865462,4889141,4894199,4894265,4901118,4921963,4925231,4928609,4932942,4933619,4939138,4948857,4963664,5012366,5012478,5012721,5014399,5034285,5047960,5052409,5053396,5072160,5075533,5089522,5089524,5103129,5110738,5121838,5133196,5151184,5160300,5170812,5174483,5217472,5241426,5254062,5263554,5272787,5279763,5280150,5282113,5286219,5313759,5327543,5331915,5331931,5332139,5345938,5364315,5364738)<br>      GROUP BY "collectionId", tf.timeframe<br>      ON CONFLICT ("collectionId", timeframe) DO UPDATE<br>        SET "itemCount" = EXCLUDED."itemCount", "updatedAt" = NOW()<br>``` |     |     |
| 11,704 min 2% | 695,267 ms | 1,010 civitai |
| ```pgsql<br>INSERT INTO "ImageResourceNew" ("imageId", "modelVersionId", strength, detected)<br>      VALUES ($1, $2, $3, $4),($5, $6, $7, $8),($9, $10, $11, $12),($13, $14, $15, $16),($17, $18, $19, $20)<br>      ON CONFLICT ("imageId", "modelVersionId") DO UPDATE<br>      SET<br>        detected = excluded.detected,<br>        strength = excluded.strength<br>``` |     |     |
| 7,317 min 1.0% | 636,284 ms | 690 civitai |
| ```pgsql<br>SELECT id, url, type, width, height, meta->>$6 as prompt<br>    FROM "Image"<br>    WHERE (<br>        ingestion = $1::"ImageIngestionStatus"<br>        AND ("scanRequestedAt" IS NULL OR "scanRequestedAt" <= now() - $2::interval)<br>      ) OR (<br>        ingestion = $3::"ImageIngestionStatus"<br>        AND "scanRequestedAt" <= now() - $4::interval<br>        AND ("scanJobs"->>$7)::int < $5<br>      )<br>``` |     |     |
| 1,031 min 0.1% | 631,335 ms | 98 civitai |
| ```pgsql<br>-- update tag engagement metrics<br>      INSERT INTO "UserMetric" ("userId", timeframe, "followerCount", "hiddenCount")<br>      SELECT<br>        "targetUserId",<br>        tf.timeframe,<br>        <br>    SUM(CASE<br>      WHEN NOT (e.type = $1) THEN $2<br>      WHEN tf.timeframe = $3 THEN $4<br>      WHEN tf.timeframe = $5 AND e."createdAt" > (NOW() - interval $6) THEN $7<br>      WHEN tf.timeframe = $8 AND e."createdAt" > (NOW() - interval $9) THEN $10<br>      WHEN tf.timeframe = $11 AND e."createdAt" > (NOW() - interval $12) THEN $13<br>      WHEN tf.timeframe = $14 AND e."createdAt" > (NOW() - interval $15) THEN $16<br>      ELSE $17<br>    END)<br>   "followerCount",<br>        <br>    SUM(CASE<br>      WHEN NOT (e.type = $18) THEN $19<br>      WHEN tf.timeframe = $20 THEN $21<br>      WHEN tf.timeframe = $22 AND e."createdAt" > (NOW() - interval $23) THEN $24<br>      WHEN tf.timeframe = $25 AND e."createdAt" > (NOW() - interval $26) THEN $27<br>      WHEN tf.timeframe = $28 AND e."createdAt" > (NOW() - interval $29) THEN $30<br>      WHEN tf.timeframe = $31 AND e."createdAt" > (NOW() - interval $32) THEN $33<br>      ELSE $34<br>    END)<br>   "hiddenCount"<br>      FROM "UserEngagement" e<br>      CROSS JOIN (SELECT unnest(enum_range($35::"MetricTimeframe")) AS timeframe) tf<br>      WHERE "targetUserId" IN ($36,$37,$38,$39,$40,$41,$42,$43,$44,$45,$46,$47,$48,$49,$50,$51,$52,$53,$54,$55,$56,$57,$58,$59,$60,$61,$62,$63,$64,$65,$66,$67,$68,$69,$70,$71,$72,$73,$74,$75,$76,$77,$78,$79,$80,$81,$82,$83,$84,$85,$86,$87,$88,$89,$90,$91,$92,$93,$94,$95,$96,$97,$98,$99,$100,$101,$102,$103,$104,$105,$106,$107,$108,$109,$110,$111,$112,$113,$114,$115,$116,$117,$118,$119,$120,$121,$122,$123,$124,$125,$126,$127,$128,$129,$130,$131,$132,$133,$134,$135,$136,$137,$138,$139,$140,$141,$142,$143,$144,$145,$146,$147,$148,$149,$150,$151,$152,$153,$154,$155,$156,$157,$158,$159,$160,$161,$162,$163,$164,$165,$166,$167,$168,$169,$170,$171,$172,$173,$174,$175,$176,$177,$178,$179,$180,$181,$182,$183,$184,$185,$186,$187,$188,$189,$190,$191,$192,$193,$194,$195,$196,$197,$198,$199,$200,$201,$202,$203,$204,$205,$206,$207,$208,$209,$210,$211,$212,$213,$214,$215,$216,$217,$218,$219,$220,$221,$222,$223,$224,$225,$226,$227,$228,$229,$230,$231,$232,$233,$234,$235,$236,$237,$238,$239,$240,$241,$242,$243,$244,$245,$246,$247,$248,$249,$250,$251,$252,$253,$254,$255,$256,$257,$258,$259,$260,$261,$262,$263,$264,$265,$266,$267,$268,$269,$270,$271,$272,$273,$274,$275,$276,$277,$278,$279,$280,$281,$282,$283,$284,$285,$286,$287,$288,$289,$290,$291,$292,$293,$294,$295,$296,$297,$298,$299,$300,$301,$302,$303,$304,$305,$306,$307,$308,$309,$310,$311,$312,$313,$314,$315,$316,$317,$318,$319,$320,$321,$322,$323,$324,$325,$326,$327,$328,$329,$330,$331,$332,$333,$334,$335,$336,$337,$338,$339,$340,$341,$342,$343,$344,$345,$346,$347,$348,$349,$350,$351,$352,$353,$354,$355,$356,$357,$358,$359,$360,$361,$362,$363,$364,$365,$366,$367,$368,$369,$370,$371,$372,$373,$374,$375,$376,$377,$378,$379,$380,$381,$382,$383,$384,$385,$386,$387,$388,$389,$390,$391,$392,$393,$394,$395,$396,$397,$398,$399,$400,$401,$402,$403,$404,$405,$406,$407,$408,$409,$410,$411,$412,$413,$414,$415,$416,$417,$418,$419,$420,$421,$422,$423,$424,$425,$426,$427,$428,$429,$430,$431,$432,$433,$434,$435,$436,$437,$438,$439,$440,$441,$442,$443,$444,$445,$446,$447,$448,$449,$450,$451,$452,$453,$454,$455,$456,$457,$458,$459,$460,$461,$462,$463,$464,$465,$466,$467,$468,$469,$470,$471,$472,$473,$474,$475,$476,$477,$478,$479,$480,$481,$482,$483,$484,$485,$486,$487,$488,$489,$490,$491,$492,$493,$494,$495,$496,$497,$498,$499,$500,$501,$502,$503,$504,$505,$506,$507,$508,$509,$510,$511,$512,$513,$514,$515,$516,$517,$518,$519,$520,$521,$522,$523,$524,$525,$526,$527,$528,$529,$530,$531,$532,$533,$534,$535,$536,$537,$538,$539,$540,$541,$542,$543,$544,$545,$546,$547,$548,$549,$550,$551,$552,$553,$554,$555,$556,$557,$558,$559,$560,$561,$562,$563,$564,$565,$566,$567,$568,$569,$570,$571,$572,$573,$574,$575,$576,$577,$578,$579,$580,$581,$582,$583,$584,$585,$586,$587,$588,$589,$590,$591,$592,$593,$594,$595,$596,$597,$598,$599,$600,$601,$602,$603,$604,$605,$606,$607,$608,$609,$610,$611,$612,$613,$614,$615,$616,$617,$618,$619,$620,$621,$622,$623,$624,$625,$626,$627,$628,$629,$630,$631,$632,$633,$634,$635,$636,$637,$638,$639,$640,$641,$642,$643,$644,$645,$646,$647,$648,$649,$650,$651,$652,$653,$654,$655,$656,$657,$658,$659,$660,$661,$662,$663,$664,$665,$666,$667,$668,$669,$670,$671,$672,$673,$674,$675,$676,$677,$678,$679,$680,$681,$682,$683,$684,$685,$686,$687,$688,$689,$690,$691,$692,$693,$694,$695,$696,$697,$698,$699,$700,$701,$702,$703,$704,$705,$706,$707,$708,$709,$710,$711,$712,$713,$714,$715,$716,$717,$718,$719,$720,$721,$722,$723,$724,$725,$726,$727,$728,$729,$730,$731,$732,$733,$734,$735,$736,$737,$738,$739,$740,$741,$742,$743,$744,$745,$746,$747,$748,$749,$750,$751,$752,$753,$754,$755,$756,$757,$758,$759,$760,$761,$762,$763,$764,$765,$766,$767,$768,$769,$770,$771,$772,$773,$774,$775,$776,$777,$778,$779,$780,$781,$782,$783,$784,$785,$786,$787,$788,$789,$790,$791,$792,$793,$794,$795,$796,$797,$798,$799,$800,$801,$802,$803,$804,$805,$806,$807,$808,$809,$810,$811,$812,$813,$814,$815,$816,$817,$818,$819,$820,$821,$822,$823,$824,$825,$826,$827,$828,$829,$830,$831,$832,$833,$834,$835,$836,$837,$838,$839,$840,$841,$842,$843,$844,$845,$846,$847,$848,$849,$850,$851,$852,$853,$854,$855,$856,$857,$858,$859,$860,$861,$862,$863,$864,$865,$866,$867,$868,$869,$870,$871,$872,$873,$874,$875,$876,$877,$878,$879,$880,$881,$882,$883,$884,$885,$886,$887,$888,$889,$890,$891,$892,$893,$894,$895,$896,$897,$898,$899,$900,$901,$902,$903,$904,$905,$906,$907,$908,$909,$910,$911,$912,$913,$914,$915,$916,$917,$918,$919,$920,$921,$922,$923,$924,$925,$926,$927,$928,$929,$930,$931,$932,$933,$934,$935,$936,$937,$938,$939,$940,$941,$942,$943,$944,$945,$946,$947,$948,$949,$950,$951,$952,$953,$954,$955,$956,$957,$958,$959,$960,$961,$962,$963,$964,$965,$966,$967,$968,$969,$970,$971,$972,$973,$974,$975,$976,$977,$978,$979,$980,$981,$982,$983,$984,$985,$986,$987,$988,$989,$990,$991,$992,$993,$994,$995,$996,$997,$998,$999,$1000,$1001,$1002,$1003,$1004,$1005,$1006,$1007,$1008,$1009,$1010,$1011,$1012,$1013,$1014,$1015,$1016,$1017,$1018,$1019,$1020,$1021,$1022,$1023,$1024,$1025,$1026,$1027,$1028,$1029,$1030,$1031,$1032,$1033,$1034,$1035)<br>      GROUP BY "targetUserId", tf.timeframe<br>      ON CONFLICT ("userId", timeframe) DO UPDATE<br>        SET "followerCount" = EXCLUDED."followerCount", "hiddenCount" = EXCLUDED."hiddenCount", "updatedAt" = NOW()<br>``` |     |     |
| 3,043 min 0.4% | 474,290 ms | 385 civitai |
| ```pgsql<br>-- update model collect metrics<br>      WITH Timeframes AS (<br>        SELECT unnest(enum_range($1::"MetricTimeframe")) AS timeframe<br>      )<br>      INSERT INTO "ModelMetric" ("modelId", timeframe, "collectedCount")<br>      SELECT<br>        c."modelId",<br>        tf.timeframe,<br>        COUNT(DISTINCT c."addedById") AS "collectedCount"<br>      FROM "CollectionItem" c<br>      JOIN Timeframes tf ON<br>        (tf.timeframe = $2)<br>        OR (tf.timeframe = $3 AND c."createdAt" > NOW() - INTERVAL $4)<br>        OR (tf.timeframe = $5 AND c."createdAt" > NOW() - INTERVAL $6)<br>        OR (tf.timeframe = $7 AND c."createdAt" > NOW() - INTERVAL $8)<br>        OR (tf.timeframe = $9 AND c."createdAt" > NOW() - INTERVAL $10)<br>      JOIN "Model" m ON m.id = c."modelId" -- ensure model exists<br>      WHERE c."modelId" = ANY (ARRAY[$11,$12,$13,$14,$15,$16,$17,$18,$19,$20,$21,$22,$23,$24,$25,$26,$27,$28,$29,$30,$31,$32,$33,$34,$35,$36,$37,$38,$39,$40,$41,$42,$43,$44,$45,$46,$47,$48,$49,$50,$51,$52,$53,$54,$55,$56,$57,$58,$59,$60,$61,$62,$63,$64,$65,$66,$67,$68,$69,$70,$71,$72,$73,$74,$75,$76,$77,$78,$79,$80,$81,$82,$83,$84,$85,$86,$87,$88,$89,$90,$91,$92,$93,$94,$95,$96,$97,$98,$99,$100,$101,$102,$103,$104,$105,$106,$107,$108,$109,$110,$111,$112,$113,$114,$115,$116,$117,$118,$119,$120,$121,$122,$123,$124,$125,$126,$127,$128,$129,$130,$131,$132,$133,$134,$135,$136,$137,$138,$139,$140,$141,$142,$143,$144,$145,$146,$147,$148,$149,$150,$151,$152,$153,$154,$155,$156,$157,$158,$159,$160,$161,$162,$163,$164,$165,$166,$167,$168,$169,$170,$171,$172,$173,$174,$175,$176,$177,$178,$179,$180,$181,$182,$183,$184,$185,$186,$187,$188,$189,$190,$191,$192,$193,$194,$195,$196,$197,$198,$199,$200,$201,$202,$203,$204,$205,$206,$207,$208,$209,$210,$211,$212,$213,$214,$215,$216,$217,$218,$219,$220,$221,$222,$223,$224,$225,$226,$227,$228,$229,$230,$231,$232,$233,$234,$235,$236,$237,$238,$239,$240,$241,$242,$243,$244,$245,$246,$247,$248,$249,$250,$251,$252,$253,$254,$255,$256,$257,$258,$259,$260,$261,$262,$263,$264,$265,$266,$267,$268,$269,$270,$271,$272,$273,$274,$275,$276,$277,$278,$279,$280,$281,$282,$283,$284,$285,$286,$287,$288,$289,$290,$291,$292,$293,$294,$295,$296,$297,$298,$299,$300,$301,$302,$303,$304,$305,$306,$307,$308,$309,$310,$311,$312,$313,$314,$315,$316,$317,$318,$319,$320,$321,$322,$323,$324,$325,$326,$327,$328,$329,$330,$331,$332,$333,$334,$335,$336,$337,$338,$339,$340,$341,$342,$343,$344,$345,$346,$347,$348,$349,$350,$351,$352,$353,$354,$355,$356,$357,$358,$359,$360,$361,$362,$363,$364,$365,$366,$367,$368,$369,$370,$371,$372,$373,$374,$375,$376,$377,$378,$379,$380,$381,$382,$383,$384,$385,$386,$387,$388,$389,$390,$391,$392,$393,$394,$395,$396,$397,$398,$399,$400,$401,$402,$403,$404,$405,$406,$407,$408,$409,$410,$411,$412,$413,$414,$415,$416,$417,$418,$419,$420,$421,$422,$423,$424,$425,$426,$427,$428,$429,$430,$431,$432,$433,$434,$435,$436,$437,$438,$439,$440,$441,$442,$443,$444,$445,$446,$447,$448,$449,$450,$451,$452,$453,$454,$455,$456,$457,$458,$459,$460,$461,$462,$463,$464,$465,$466,$467,$468,$469,$470,$471,$472,$473,$474,$475,$476,$477,$478,$479,$480,$481,$482,$483,$484,$485,$486,$487,$488,$489,$490,$491,$492,$493,$494,$495,$496,$497,$498,$499,$500,$501,$502,$503,$504,$505,$506,$507,$508,$509,$510,$511,$512,$513,$514,$515,$516,$517,$518,$519,$520,$521,$522,$523,$524,$525,$526,$527,$528,$529,$530,$531,$532,$533,$534,$535,$536,$537,$538,$539,$540,$541,$542,$543,$544,$545,$546,$547,$548,$549,$550,$551,$552,$553,$554,$555,$556,$557,$558,$559,$560,$561,$562,$563,$564,$565,$566,$567,$568,$569,$570,$571,$572,$573,$574,$575,$576,$577,$578,$579,$580,$581,$582,$583,$584,$585,$586,$587,$588,$589,$590,$591,$592,$593,$594,$595,$596,$597,$598,$599,$600,$601,$602,$603,$604,$605,$606,$607,$608,$609,$610,$611,$612,$613,$614,$615,$616,$617,$618,$619,$620,$621,$622,$623,$624,$625,$626,$627,$628,$629,$630,$631,$632,$633,$634,$635,$636,$637,$638,$639,$640,$641,$642,$643,$644,$645,$646,$647,$648,$649,$650,$651,$652,$653,$654,$655,$656,$657,$658,$659,$660,$661,$662,$663,$664,$665,$666,$667,$668,$669,$670,$671,$672,$673,$674,$675,$676,$677,$678,$679,$680,$681,$682,$683,$684,$685,$686,$687,$688,$689,$690,$691,$692,$693,$694,$695,$696,$697,$698,$699,$700,$701,$702,$703,$704,$705,$706,$707,$708,$709,$710,$711,$712,$713,$714,$715,$716,$717,$718,$719,$720,$721,$722,$723,$724,$725,$726,$727,$728,$729,$730,$731,$732,$733,$734,$735,$736,$737,$738,$739,$740,$741,$742,$743,$744,$745,$746,$747,$748,$749,$750,$751,$752,$753,$754,$755,$756,$757,$758,$759,$760,$761,$762,$763,$764,$765,$766,$767,$768,$769,$770,$771,$772,$773,$774,$775,$776,$777,$778,$779,$780,$781,$782,$783,$784,$785,$786,$787,$788,$789,$790,$791,$792,$793,$794,$795,$796,$797,$798,$799,$800,$801,$802,$803,$804,$805,$806,$807,$808,$809,$810,$811,$812,$813,$814,$815,$816,$817,$818,$819,$820,$821,$822,$823,$824,$825,$826,$827,$828,$829,$830,$831,$832,$833,$834,$835,$836,$837,$838,$839,$840,$841,$842,$843,$844,$845,$846,$847,$848,$849,$850,$851,$852,$853,$854,$855,$856,$857,$858,$859,$860,$861,$862,$863,$864,$865,$866,$867,$868,$869,$870,$871,$872,$873,$874,$875,$876,$877,$878,$879,$880,$881,$882,$883,$884,$885,$886,$887,$888,$889,$890,$891,$892,$893,$894,$895,$896,$897,$898,$899,$900,$901,$902,$903,$904,$905,$906,$907,$908,$909,$910,$911,$912,$913,$914,$915,$916,$917,$918,$919,$920,$921,$922,$923,$924,$925,$926,$927,$928,$929,$930,$931,$932,$933,$934,$935,$936,$937,$938,$939,$940,$941,$942,$943,$944,$945,$946,$947,$948,$949,$950,$951,$952,$953,$954,$955,$956,$957,$958,$959,$960,$961,$962,$963,$964,$965,$966,$967,$968,$969,$970,$971,$972,$973,$974,$975,$976,$977,$978,$979,$980,$981,$982,$983,$984,$985,$986,$987,$988,$989,$990,$991,$992,$993,$994,$995,$996,$997,$998,$999,$1000,$1001,$1002,$1003,$1004,$1005,$1006,$1007,$1008,$1009,$1010])<br>        AND c."modelId" BETWEEN $1011 AND $1012<br>      GROUP BY c."modelId", tf.timeframe<br>      ON CONFLICT ("modelId", timeframe) DO UPDATE<br>        SET "collectedCount" = EXCLUDED."collectedCount", "updatedAt" = now()<br>``` |     |     |
| 2,131 min 0.3% | 364,226 ms | 351 civitai |
| ```pgsql<br>-- update model rating metrics<br>      INSERT INTO "ModelMetric" ("modelId", timeframe, "thumbsUpCount", "thumbsDownCount")<br>      SELECT<br>        r."modelId",<br>        tf.timeframe,<br>        <br>    COUNT(DISTINCT CASE<br>      WHEN NOT (recommended) THEN $1<br>      WHEN tf.timeframe = $2 THEN r."userId"<br>      WHEN tf.timeframe = $3 AND r."createdAt" > (NOW() - interval $4) THEN r."userId"<br>      WHEN tf.timeframe = $5 AND r."createdAt" > (NOW() - interval $6) THEN r."userId"<br>      WHEN tf.timeframe = $7 AND r."createdAt" > (NOW() - interval $8) THEN r."userId"<br>      WHEN tf.timeframe = $9 AND r."createdAt" > (NOW() - interval $10) THEN r."userId"<br>      ELSE $11<br>    END)<br>   "thumbsUpCount",<br>        <br>    COUNT(DISTINCT CASE<br>      WHEN NOT (NOT recommended) THEN $12<br>      WHEN tf.timeframe = $13 THEN r."userId"<br>      WHEN tf.timeframe = $14 AND r."createdAt" > (NOW() - interval $15) THEN r."userId"<br>      WHEN tf.timeframe = $16 AND r."createdAt" > (NOW() - interval $17) THEN r."userId"<br>      WHEN tf.timeframe = $18 AND r."createdAt" > (NOW() - interval $19) THEN r."userId"<br>      WHEN tf.timeframe = $20 AND r."createdAt" > (NOW() - interval $21) THEN r."userId"<br>      ELSE $22<br>    END)<br>   "thumbsDownCount"<br>      FROM "ResourceReview" r<br>      CROSS JOIN ( SELECT unnest(enum_range($23::"MetricTimeframe")) AS timeframe ) tf<br>      WHERE r.exclude = $24<br>        AND r."tosViolation" = $25<br>        AND r."modelId" IN ($26,$27,$28,$29,$30,$31,$32,$33,$34,$35,$36,$37,$38,$39,$40,$41,$42,$43,$44,$45,$46,$47,$48,$49,$50,$51,$52,$53,$54,$55,$56,$57,$58,$59,$60,$61,$62,$63,$64,$65,$66,$67,$68,$69,$70,$71,$72,$73,$74,$75,$76,$77,$78,$79,$80,$81,$82,$83,$84,$85,$86,$87,$88,$89,$90,$91,$92,$93,$94,$95,$96,$97,$98,$99,$100,$101,$102,$103,$104,$105,$106,$107,$108,$109,$110,$111,$112,$113,$114,$115,$116,$117,$118,$119,$120,$121,$122,$123,$124,$125,$126,$127,$128,$129,$130,$131,$132,$133,$134,$135,$136,$137,$138,$139,$140,$141,$142,$143,$144,$145,$146,$147,$148,$149,$150,$151,$152,$153,$154,$155,$156,$157,$158,$159,$160,$161,$162,$163,$164,$165,$166,$167,$168,$169,$170,$171,$172,$173,$174,$175,$176,$177,$178,$179,$180,$181,$182,$183,$184,$185,$186,$187,$188,$189,$190,$191,$192,$193,$194,$195,$196,$197,$198,$199,$200,$201,$202,$203,$204,$205,$206,$207,$208,$209,$210,$211,$212,$213,$214,$215,$216,$217,$218,$219,$220,$221,$222,$223,$224,$225,$226,$227,$228,$229,$230,$231,$232,$233,$234,$235,$236,$237,$238,$239,$240,$241,$242,$243,$244,$245,$246,$247,$248,$249,$250,$251,$252,$253,$254,$255,$256,$257,$258,$259,$260,$261,$262,$263,$264,$265,$266,$267,$268,$269,$270,$271,$272,$273,$274,$275,$276,$277,$278,$279,$280,$281,$282,$283,$284,$285,$286,$287,$288,$289,$290,$291,$292,$293,$294,$295,$296,$297,$298,$299,$300,$301,$302,$303,$304,$305,$306,$307,$308,$309,$310,$311,$312,$313,$314,$315,$316,$317,$318,$319,$320,$321,$322,$323,$324,$325,$326,$327,$328,$329,$330,$331,$332,$333,$334,$335,$336,$337,$338,$339,$340,$341,$342,$343,$344,$345,$346,$347,$348,$349,$350,$351,$352,$353,$354,$355,$356,$357,$358,$359,$360,$361,$362,$363,$364,$365,$366,$367,$368,$369,$370,$371,$372,$373,$374,$375,$376,$377,$378,$379,$380,$381,$382,$383,$384,$385,$386,$387,$388,$389,$390,$391,$392,$393,$394,$395,$396,$397,$398,$399,$400,$401,$402,$403,$404,$405,$406,$407,$408,$409,$410,$411,$412,$413,$414,$415,$416,$417,$418,$419,$420,$421,$422,$423,$424,$425,$426,$427,$428,$429,$430,$431,$432,$433,$434,$435,$436,$437,$438,$439,$440,$441,$442,$443,$444,$445,$446,$447,$448,$449,$450,$451,$452,$453,$454,$455,$456,$457,$458,$459,$460,$461,$462,$463,$464,$465,$466,$467,$468,$469,$470,$471,$472,$473,$474,$475,$476,$477,$478,$479,$480,$481,$482,$483,$484,$485,$486,$487,$488,$489,$490,$491,$492,$493,$494,$495,$496,$497,$498,$499,$500,$501,$502,$503,$504,$505,$506,$507,$508,$509,$510,$511,$512,$513,$514,$515,$516,$517,$518,$519,$520,$521,$522,$523,$524,$525,$526,$527,$528,$529,$530,$531,$532,$533,$534,$535,$536,$537,$538,$539,$540,$541,$542,$543,$544,$545,$546,$547,$548,$549,$550,$551,$552,$553,$554,$555,$556,$557,$558,$559,$560,$561,$562,$563,$564,$565,$566,$567,$568,$569,$570,$571,$572,$573,$574,$575,$576,$577,$578,$579,$580,$581,$582,$583,$584,$585,$586,$587,$588,$589,$590,$591,$592,$593,$594,$595,$596,$597,$598,$599,$600,$601,$602,$603,$604,$605,$606,$607,$608,$609,$610,$611,$612,$613,$614,$615,$616,$617,$618,$619,$620,$621,$622,$623,$624,$625,$626,$627,$628,$629,$630,$631,$632,$633,$634,$635,$636,$637,$638,$639,$640,$641,$642,$643,$644,$645,$646,$647,$648,$649,$650,$651,$652,$653,$654,$655,$656,$657,$658,$659,$660,$661,$662,$663,$664,$665,$666,$667,$668,$669,$670,$671,$672,$673,$674,$675,$676,$677,$678,$679,$680,$681,$682,$683,$684,$685,$686,$687,$688,$689,$690,$691,$692,$693,$694,$695,$696,$697,$698,$699,$700,$701,$702,$703,$704,$705,$706,$707,$708,$709,$710,$711,$712,$713,$714,$715,$716,$717,$718,$719,$720,$721,$722,$723,$724,$725,$726,$727,$728,$729,$730,$731,$732,$733,$734,$735,$736,$737,$738,$739,$740,$741,$742,$743,$744,$745,$746,$747,$748,$749,$750,$751,$752,$753,$754,$755,$756,$757,$758,$759,$760,$761,$762,$763,$764,$765,$766,$767,$768,$769,$770,$771,$772,$773,$774,$775,$776,$777,$778,$779,$780,$781,$782,$783,$784,$785,$786,$787,$788,$789,$790,$791,$792,$793,$794,$795,$796,$797,$798,$799,$800,$801,$802,$803,$804,$805,$806,$807,$808,$809,$810,$811,$812,$813,$814,$815,$816,$817,$818,$819,$820,$821,$822,$823,$824,$825,$826,$827,$828,$829,$830,$831,$832,$833,$834,$835,$836,$837,$838,$839,$840,$841,$842,$843,$844,$845,$846,$847,$848,$849,$850,$851,$852,$853,$854,$855,$856,$857,$858,$859,$860,$861,$862,$863,$864,$865,$866,$867,$868,$869,$870,$871,$872,$873,$874,$875,$876,$877,$878,$879,$880,$881,$882,$883,$884,$885,$886,$887,$888,$889,$890,$891,$892,$893,$894,$895,$896,$897,$898,$899,$900,$901,$902,$903,$904,$905,$906,$907,$908,$909,$910,$911,$912,$913,$914,$915,$916,$917,$918,$919,$920,$921,$922,$923,$924,$925,$926,$927,$928,$929,$930,$931,$932,$933,$934,$935,$936,$937,$938,$939,$940,$941,$942,$943,$944,$945,$946,$947,$948,$949,$950,$951,$952,$953,$954,$955,$956,$957,$958,$959,$960,$961,$962,$963,$964,$965,$966,$967,$968,$969,$970,$971,$972,$973,$974,$975,$976,$977,$978,$979,$980,$981,$982,$983,$984,$985,$986,$987,$988,$989,$990,$991,$992,$993,$994,$995,$996,$997,$998,$999,$1000,$1001,$1002,$1003,$1004,$1005,$1006,$1007,$1008,$1009,$1010,$1011,$1012,$1013,$1014,$1015,$1016,$1017,$1018,$1019,$1020,$1021,$1022,$1023,$1024,$1025)<br>      GROUP BY r."modelId", tf.timeframe<br>      ON CONFLICT ("modelId", timeframe) DO UPDATE<br>        SET "thumbsUpCount" = EXCLUDED."thumbsUpCount", "thumbsDownCount" = EXCLUDED."thumbsDownCount", "updatedAt" = now()<br>``` |     |     |
| 190 min < 0.1% | 277,662 ms | 41 civitai |
| ```pgsql<br>-- get recent post image reactions<br>      SELECT DISTINCT<br>        i."postId" AS id<br>      FROM "Image" i<br>      WHERE i.id IN ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12,$13,$14,$15,$16,$17,$18,$19,$20,$21,$22,$23,$24,$25,$26,$27,$28,$29,$30,$31,$32,$33,$34,$35,$36,$37,$38,$39,$40,$41,$42,$43,$44,$45,$46,$47,$48,$49,$50,$51,$52,$53,$54,$55,$56,$57,$58,$59,$60,$61,$62,$63,$64,$65,$66,$67,$68,$69,$70,$71,$72,$73,$74,$75,$76,$77,$78,$79,$80,$81,$82,$83,$84,$85,$86,$87,$88,$89,$90,$91,$92,$93,$94,$95,$96,$97,$98,$99,$100,$101,$102,$103,$104,$105,$106,$107,$108,$109,$110,$111,$112,$113,$114,$115,$116,$117,$118,$119,$120,$121,$122,$123,$124,$125,$126,$127,$128,$129,$130,$131,$132,$133,$134,$135,$136,$137,$138,$139,$140,$141,$142,$143,$144,$145,$146,$147,$148,$149,$150,$151,$152,$153,$154,$155,$156,$157,$158,$159,$160,$161,$162,$163,$164,$165,$166,$167,$168,$169,$170,$171,$172,$173,$174,$175,$176,$177,$178,$179,$180,$181,$182,$183,$184,$185,$186,$187,$188,$189,$190,$191,$192,$193,$194,$195,$196,$197,$198,$199,$200,$201,$202,$203,$204,$205,$206,$207,$208,$209,$210,$211,$212,$213,$214,$215,$216,$217,$218,$219,$220,$221,$222,$223,$224,$225,$226,$227,$228,$229,$230,$231,$232,$233,$234,$235,$236,$237,$238,$239,$240,$241,$242,$243,$244,$245,$246,$247,$248,$249,$250,$251,$252,$253,$254,$255,$256,$257,$258,$259,$260,$261,$262,$263,$264,$265,$266,$267,$268,$269,$270,$271,$272,$273,$274,$275,$276,$277,$278,$279,$280,$281,$282,$283,$284,$285,$286,$287,$288,$289,$290,$291,$292,$293,$294,$295,$296,$297,$298,$299,$300,$301,$302,$303,$304,$305,$306,$307,$308,$309,$310,$311,$312,$313,$314,$315,$316,$317,$318,$319,$320,$321,$322,$323,$324,$325,$326,$327,$328,$329,$330,$331,$332,$333,$334,$335,$336,$337,$338,$339,$340,$341,$342,$343,$344,$345,$346,$347,$348,$349,$350,$351,$352,$353,$354,$355,$356,$357,$358,$359,$360,$361,$362,$363,$364,$365,$366,$367,$368,$369,$370,$371,$372,$373,$374,$375,$376,$377,$378,$379,$380,$381,$382,$383,$384,$385,$386,$387,$388,$389,$390,$391,$392,$393,$394,$395,$396,$397,$398,$399,$400,$401,$402,$403,$404,$405,$406,$407,$408,$409,$410,$411,$412,$413,$414,$415,$416,$417,$418,$419,$420,$421,$422,$423,$424,$425,$426,$427,$428,$429,$430,$431,$432,$433,$434,$435,$436,$437,$438,$439,$440,$441,$442,$443,$444,$445,$446,$447,$448,$449,$450,$451,$452,$453,$454,$455,$456,$457,$458,$459,$460,$461,$462,$463,$464,$465,$466,$467,$468,$469,$470,$471,$472,$473,$474,$475,$476,$477,$478,$479,$480,$481,$482,$483,$484,$485,$486,$487,$488,$489,$490,$491,$492,$493,$494,$495,$496,$497,$498,$499,$500,$501,$502,$503,$504,$505,$506,$507,$508,$509,$510,$511,$512,$513,$514,$515,$516,$517,$518,$519,$520,$521,$522,$523,$524,$525,$526,$527,$528,$529,$530,$531,$532,$533,$534,$535,$536,$537,$538,$539,$540,$541,$542,$543,$544,$545,$546,$547,$548,$549,$550,$551,$552,$553,$554,$555,$556,$557,$558,$559,$560,$561,$562,$563,$564,$565,$566,$567,$568,$569,$570,$571,$572,$573,$574,$575,$576,$577,$578,$579,$580,$581,$582,$583,$584,$585,$586,$587,$588,$589,$590,$591,$592,$593,$594,$595,$596,$597,$598,$599,$600,$601,$602,$603,$604,$605,$606,$607,$608,$609,$610,$611,$612,$613,$614,$615,$616,$617,$618,$619,$620,$621,$622,$623,$624,$625,$626,$627,$628,$629,$630,$631,$632,$633,$634,$635,$636,$637,$638,$639,$640,$641,$642,$643,$644,$645,$646,$647,$648,$649,$650,$651,$652,$653,$654,$655,$656,$657,$658,$659,$660,$661,$662,$663,$664,$665,$666,$667,$668,$669,$670,$671,$672,$673,$674,$675,$676,$677,$678,$679,$680,$681,$682,$683,$684,$685,$686,$687,$688,$689,$690,$691,$692,$693,$694,$695,$696,$697,$698,$699,$700,$701,$702,$703,$704,$705,$706,$707,$708,$709,$710,$711,$712,$713,$714,$715,$716,$717,$718,$719,$720,$721,$722,$723,$724,$725,$726,$727,$728,$729,$730,$731,$732,$733,$734,$735,$736,$737,$738,$739,$740,$741,$742,$743,$744,$745,$746,$747,$748,$749,$750,$751,$752,$753,$754,$755,$756,$757,$758,$759,$760,$761,$762,$763,$764,$765,$766,$767,$768,$769,$770,$771,$772,$773,$774,$775,$776,$777,$778,$779,$780,$781,$782,$783,$784,$785,$786,$787,$788,$789,$790,$791,$792,$793,$794,$795,$796,$797,$798,$799,$800,$801,$802,$803,$804,$805,$806,$807,$808,$809,$810,$811,$812,$813,$814,$815,$816,$817,$818,$819,$820,$821,$822,$823,$824,$825,$826,$827,$828,$829,$830,$831,$832,$833,$834,$835,$836,$837,$838,$839,$840,$841,$842,$843,$844,$845,$846,$847,$848,$849,$850,$851,$852,$853,$854,$855,$856,$857,$858,$859,$860,$861,$862,$863,$864,$865,$866,$867,$868,$869,$870,$871,$872,$873,$874,$875,$876,$877,$878,$879,$880,$881,$882,$883,$884,$885,$886,$887,$888,$889,$890,$891,$892,$893,$894,$895,$896,$897,$898,$899,$900,$901,$902,$903,$904,$905,$906,$907,$908,$909,$910,$911,$912,$913,$914,$915,$916,$917,$918,$919,$920,$921,$922,$923,$924,$925,$926,$927,$928,$929,$930,$931,$932,$933,$934,$935,$936,$937,$938,$939,$940,$941,$942,$943,$944,$945,$946,$947,$948,$949,$950,$951,$952,$953,$954,$955,$956,$957,$958,$959,$960,$961,$962,$963,$964,$965,$966,$967,$968,$969,$970,$971,$972,$973,$974,$975,$976,$977,$978,$979,$980,$981,$982,$983,$984,$985,$986,$987,$988,$989,$990,$991,$992,$993,$994,$995,$996,$997,$998,$999,$1000,$1001,$1002,$1003,$1004,$1005,$1006,$1007,$1008,$1009,$1010,$1011,$1012,$1013,$1014,$1015,$1016,$1017,$1018,$1019,$1020,$1021,$1022,$1023,$1024,$1025,$1026,$1027,$1028,$1029,$1030,$1031,$1032,$1033,$1034,$1035,$1036,$1037,$1038,$1039,$1040,$1041,$1042,$1043,$1044,$1045,$1046,$1047,$1048,$1049,$1050,$1051,$1052,$1053,$1054,$1055,$1056,$1057,$1058,$1059,$1060,$1061,$1062,$1063,$1064,$1065,$1066,$1067,$1068,$1069,$1070,$1071,$1072,$1073,$1074,$1075,$1076,$1077,$1078,$1079,$1080,$1081,$1082,$1083,$1084,$1085,$1086,$1087,$1088,$1089,$1090,$1091,$1092,$1093,$1094,$1095,$1096,$1097,$1098,$1099,$1100,$1101,$1102,$1103,$1104,$1105,$1106,$1107,$1108,$1109,$1110,$1111,$1112,$1113,$1114,$1115,$1116,$1117,$1118,$1119,$1120,$1121,$1122,$1123,$1124,$1125,$1126,$1127,$1128,$1129,$1130,$1131,$1132,$1133,$1134,$1135,$1136,$1137,$1138,$1139,$1140,$1141,$1142,$1143,$1144,$1145,$1146,$1147,$1148,$1149,$1150,$1151,$1152,$1153,$1154,$1155,$1156,$1157,$1158,$1159,$1160,$1161,$1162,$1163,$1164,$1165,$1166,$1167,$1168,$1169,$1170,$1171,$1172,$1173,$1174,$1175,$1176,$1177,$1178,$1179,$1180,$1181,$1182,$1183,$1184,$1185,$1186,$1187,$1188,$1189,$1190,$1191,$1192,$1193,$1194,$1195,$1196,$1197,$1198,$1199,$1200,$1201,$1202,$1203,$1204,$1205,$1206,$1207,$1208,$1209,$1210,$1211,$1212,$1213,$1214,$1215,$1216,$1217,$1218,$1219,$1220,$1221,$1222,$1223,$1224,$1225,$1226,$1227,$1228,$1229,$1230,$1231,$1232,$1233,$1234,$1235,$1236,$1237,$1238,$1239,$1240,$1241,$1242,$1243,$1244,$1245,$1246,$1247,$1248,$1249,$1250,$1251,$1252,$1253,$1254,$1255,$1256,$1257,$1258,$1259,$1260,$1261,$1262,$1263,$1264,$1265,$1266,$1267,$1268,$1269,$1270,$1271,$1272,$1273,$1274,$1275,$1276,$1277,$1278,$1279,$1280,$1281,$1282,$1283,$1284,$1285,$1286,$1287,$1288,$1289,$1290,$1291,$1292,$1293,$1294,$1295,$1296,$1297,$1298,$1299,$1300,$1301,$1302,$1303,$1304,$1305,$1306,$1307,$1308,$1309,$1310,$1311,$1312,$1313,$1314,$1315,$1316,$1317,$1318,$1319,$1320,$1321,$1322,$1323,$1324,$1325,$1326,$1327,$1328,$1329,$1330,$1331,$1332,$1333,$1334,$1335,$1336,$1337,$1338,$1339,$1340,$1341,$1342,$1343,$1344,$1345,$1346,$1347,$1348,$1349,$1350,$1351,$1352,$1353,$1354,$1355,$1356,$1357,$1358,$1359,$1360,$1361,$1362,$1363,$1364,$1365,$1366,$1367,$1368,$1369,$1370,$1371,$1372,$1373,$1374,$1375,$1376,$1377,$1378,$1379,$1380,$1381,$1382,$1383,$1384,$1385,$1386,$1387,$1388,$1389,$1390,$1391,$1392,$1393,$1394,$1395,$1396,$1397,$1398,$1399,$1400,$1401,$1402,$1403,$1404,$1405,$1406,$1407,$1408,$1409,$1410,$1411,$1412,$1413,$1414,$1415,$1416,$1417,$1418,$1419,$1420,$1421,$1422,$1423,$1424,$1425,$1426,$1427,$1428,$1429,$1430,$1431,$1432,$1433,$1434,$1435,$1436,$1437,$1438,$1439,$1440,$1441,$1442,$1443,$1444,$1445,$1446,$1447,$1448,$1449,$1450,$1451,$1452,$1453,$1454,$1455,$1456,$1457,$1458,$1459,$1460,$1461,$1462,$1463,$1464,$1465,$1466,$1467,$1468,$1469,$1470,$1471,$1472,$1473,$1474,$1475,$1476,$1477,$1478,$1479,$1480,$1481,$1482,$1483,$1484,$1485,$1486,$1487,$1488,$1489,$1490,$1491,$1492,$1493,$1494,$1495,$1496,$1497,$1498,$1499,$1500,$1501,$1502,$1503,$1504,$1505,$1506,$1507,$1508,$1509,$1510,$1511,$1512,$1513,$1514,$1515,$1516,$1517,$1518,$1519,$1520,$1521,$1522,$1523,$1524,$1525,$1526,$1527,$1528,$1529,$1530,$1531,$1532,$1533,$1534,$1535,$1536,$1537,$1538,$1539,$1540,$1541,$1542,$1543,$1544,$1545,$1546,$1547,$1548,$1549,$1550,$1551,$1552,$1553,$1554,$1555,$1556,$1557,$1558,$1559,$1560,$1561,$1562,$1563,$1564,$1565,$1566,$1567,$1568,$1569,$1570,$1571,$1572,$1573,$1574,$1575,$1576,$1577,$1578,$1579,$1580,$1581,$1582,$1583,$1584,$1585,$1586,$1587,$1588,$1589,$1590,$1591,$1592,$1593,$1594,$1595,$1596,$1597,$1598,$1599,$1600,$1601,$1602,$1603,$1604,$1605,$1606,$1607,$1608,$1609,$1610,$1611,$1612,$1613,$1614,$1615,$1616,$1617,$1618,$1619,$1620,$1621,$1622,$1623,$1624,$1625,$1626,$1627,$1628,$1629,$1630,$1631,$1632,$1633,$1634,$1635,$1636,$1637,$1638,$1639,$1640,$1641,$1642,$1643,$1644,$1645,$1646,$1647,$1648,$1649,$1650,$1651,$1652,$1653,$1654,$1655,$1656,$1657,$1658,$1659,$1660,$1661,$1662,$1663,$1664,$1665,$1666,$1667,$1668,$1669,$1670,$1671,$1672,$1673,$1674,$1675,$1676,$1677,$1678,$1679,$1680,$1681,$1682,$1683,$1684,$1685,$1686,$1687,$1688,$1689,$1690,$1691,$1692,$1693,$1694,$1695,$1696,$1697,$1698,$1699,$1700,$1701,$1702,$1703,$1704,$1705,$1706,$1707,$1708,$1709,$1710,$1711,$1712,$1713,$1714,$1715,$1716,$1717,$1718,$1719,$1720,$1721,$1722,$1723,$1724,$1725,$1726,$1727,$1728,$1729,$1730,$1731,$1732,$1733,$1734,$1735,$1736,$1737,$1738,$1739,$1740,$1741,$1742,$1743,$1744,$1745,$1746,$1747,$1748,$1749,$1750,$1751,$1752,$1753,$1754,$1755,$1756,$1757,$1758,$1759,$1760,$1761,$1762,$1763,$1764,$1765,$1766,$1767,$1768,$1769,$1770,$1771,$1772,$1773,$1774,$1775,$1776,$1777,$1778,$1779,$1780,$1781,$1782,$1783,$1784,$1785,$1786,$1787,$1788,$1789,$1790,$1791,$1792,$1793,$1794,$1795,$1796,$1797,$1798,$1799,$1800,$1801,$1802,$1803,$1804,$1805,$1806,$1807,$1808,$1809,$1810,$1811,$1812,$1813,$1814,$1815,$1816,$1817,$1818,$1819,$1820,$1821,$1822,$1823,$1824,$1825,$1826,$1827,$1828,$1829,$1830,$18<br>``` |     |     |
| 3 min < 0.1% | 204,728 ms | 1 civitai |
| ```pgsql<br>SELECT<br>          m."userId",<br>          SUM(mm."thumbsUpCount") AS "thumbsUpCount",<br>          SUM(mm."downloadCount") AS "downladCount"<br>        FROM "ModelMetric" mm<br>        JOIN "Model" m ON m.id = mm."modelId"<br>        WHERE m."userId" IN ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12,$13,$14,$15,$16,$17,$18,$19,$20,$21,$22,$23,$24,$25,$26,$27,$28,$29,$30,$31,$32,$33,$34,$35,$36,$37,$38,$39,$40,$41,$42,$43,$44,$45,$46,$47,$48,$49,$50,$51,$52,$53,$54,$55,$56,$57,$58,$59,$60,$61,$62,$63,$64,$65,$66,$67,$68,$69,$70,$71,$72,$73,$74,$75,$76,$77,$78,$79,$80,$81,$82,$83,$84,$85,$86,$87,$88,$89,$90,$91,$92,$93,$94,$95,$96,$97,$98,$99,$100,$101,$102,$103,$104,$105,$106,$107,$108,$109,$110,$111,$112,$113,$114,$115,$116,$117,$118,$119,$120,$121,$122,$123,$124,$125,$126,$127,$128,$129,$130,$131,$132,$133,$134,$135,$136,$137,$138,$139,$140,$141,$142,$143,$144,$145,$146,$147,$148,$149,$150,$151,$152,$153,$154,$155,$156,$157,$158,$159,$160,$161,$162,$163,$164,$165,$166,$167,$168,$169,$170,$171,$172,$173,$174,$175,$176,$177,$178,$179,$180,$181,$182,$183,$184,$185,$186,$187,$188,$189,$190,$191,$192,$193,$194,$195,$196,$197,$198,$199,$200,$201,$202,$203,$204,$205,$206,$207,$208,$209,$210,$211,$212,$213,$214,$215,$216,$217,$218,$219,$220,$221,$222,$223,$224,$225,$226,$227,$228,$229,$230,$231,$232,$233,$234,$235,$236,$237,$238,$239,$240,$241,$242,$243,$244,$245,$246,$247,$248,$249,$250,$251,$252,$253,$254,$255,$256,$257,$258,$259,$260,$261,$262,$263,$264,$265,$266,$267,$268,$269,$270,$271,$272,$273,$274,$275,$276,$277,$278,$279,$280,$281,$282,$283,$284,$285,$286,$287,$288,$289,$290,$291,$292,$293,$294,$295,$296,$297,$298,$299,$300,$301,$302,$303,$304,$305,$306,$307,$308,$309,$310,$311,$312,$313,$314,$315,$316,$317,$318,$319,$320,$321,$322,$323,$324,$325,$326,$327,$328,$329,$330,$331,$332,$333,$334,$335,$336,$337,$338,$339,$340,$341,$342,$343,$344,$345,$346,$347,$348,$349,$350,$351,$352,$353,$354,$355,$356,$357,$358,$359,$360,$361,$362,$363,$364,$365,$366,$367,$368,$369,$370,$371,$372,$373,$374,$375,$376,$377,$378,$379,$380,$381,$382,$383,$384,$385,$386,$387,$388,$389,$390,$391,$392,$393,$394,$395,$396,$397,$398,$399,$400,$401,$402,$403,$404,$405,$406,$407,$408,$409,$410,$411,$412,$413,$414,$415,$416,$417,$418,$419,$420,$421,$422,$423,$424,$425,$426,$427,$428,$429,$430,$431,$432,$433,$434,$435,$436,$437,$438,$439,$440,$441,$442,$443,$444,$445,$446,$447,$448,$449,$450,$451,$452,$453,$454,$455,$456,$457,$458,$459,$460,$461,$462,$463,$464,$465,$466,$467,$468,$469,$470,$471,$472,$473,$474,$475,$476,$477,$478,$479,$480,$481,$482,$483,$484,$485,$486,$487,$488,$489,$490,$491,$492,$493,$494,$495,$496,$497,$498,$499,$500,$501,$502,$503,$504,$505,$506,$507,$508,$509,$510,$511,$512,$513,$514,$515,$516,$517,$518,$519,$520,$521,$522,$523,$524,$525,$526,$527,$528,$529,$530,$531,$532,$533,$534,$535,$536,$537,$538,$539,$540,$541,$542,$543,$544,$545,$546,$547,$548,$549,$550,$551,$552,$553,$554,$555,$556,$557,$558,$559,$560,$561,$562,$563,$564,$565,$566,$567,$568,$569,$570,$571,$572,$573,$574,$575,$576,$577,$578,$579,$580,$581,$582,$583,$584,$585,$586,$587,$588,$589,$590,$591,$592,$593,$594,$595,$596,$597,$598,$599,$600,$601,$602,$603,$604,$605,$606,$607,$608,$609,$610,$611,$612,$613)<br>          AND mm.timeframe = $614::"MetricTimeframe"<br>        GROUP BY m."userId"<br>``` |     |     |
| 1,092 min 0.1% | 179,584 ms | 365 civitai |
| ```pgsql<br>-- update version rating metrics<br>      INSERT INTO "ModelVersionMetric" ("modelVersionId", timeframe, "thumbsUpCount", "thumbsDownCount")<br>      SELECT<br>        r."modelVersionId",<br>        tf.timeframe,<br>        <br>    COUNT(DISTINCT CASE<br>      WHEN NOT (recommended) THEN $1<br>      WHEN tf.timeframe = $2 THEN r."userId"<br>      WHEN tf.timeframe = $3 AND r."createdAt" > (NOW() - interval $4) THEN r."userId"<br>      WHEN tf.timeframe = $5 AND r."createdAt" > (NOW() - interval $6) THEN r."userId"<br>      WHEN tf.timeframe = $7 AND r."createdAt" > (NOW() - interval $8) THEN r."userId"<br>      WHEN tf.timeframe = $9 AND r."createdAt" > (NOW() - interval $10) THEN r."userId"<br>      ELSE $11<br>    END)<br>   "thumbsUpCount",<br>        <br>    COUNT(DISTINCT CASE<br>      WHEN NOT (NOT recommended) THEN $12<br>      WHEN tf.timeframe = $13 THEN r."userId"<br>      WHEN tf.timeframe = $14 AND r."createdAt" > (NOW() - interval $15) THEN r."userId"<br>      WHEN tf.timeframe = $16 AND r."createdAt" > (NOW() - interval $17) THEN r."userId"<br>      WHEN tf.timeframe = $18 AND r."createdAt" > (NOW() - interval $19) THEN r."userId"<br>      WHEN tf.timeframe = $20 AND r."createdAt" > (NOW() - interval $21) THEN r."userId"<br>      ELSE $22<br>    END)<br>   "thumbsDownCount"<br>      FROM "ResourceReview" r<br>      CROSS JOIN ( SELECT unnest(enum_range($23::"MetricTimeframe")) AS timeframe ) tf<br>      WHERE r.exclude = $24<br>        AND r."tosViolation" = $25<br>        AND r."modelVersionId" IN ($26,$27,$28,$29,$30,$31,$32,$33,$34,$35,$36,$37,$38,$39,$40,$41,$42,$43,$44,$45,$46,$47,$48,$49,$50,$51,$52,$53,$54,$55,$56,$57,$58,$59,$60,$61,$62,$63,$64,$65,$66,$67,$68,$69,$70,$71,$72,$73,$74,$75,$76,$77,$78,$79,$80,$81,$82,$83,$84,$85,$86,$87,$88,$89,$90,$91,$92,$93,$94,$95,$96,$97,$98,$99,$100,$101,$102,$103,$104,$105,$106,$107,$108,$109,$110,$111,$112,$113,$114,$115,$116,$117,$118,$119,$120,$121,$122,$123,$124,$125,$126,$127,$128,$129,$130,$131,$132,$133,$134,$135,$136,$137,$138,$139,$140,$141,$142,$143,$144,$145,$146,$147,$148,$149,$150,$151,$152,$153,$154,$155,$156,$157,$158,$159,$160,$161,$162,$163,$164,$165,$166,$167,$168,$169,$170,$171,$172,$173,$174,$175,$176,$177,$178,$179,$180,$181,$182,$183,$184,$185,$186,$187,$188,$189,$190,$191,$192,$193,$194,$195,$196,$197,$198,$199,$200,$201,$202,$203,$204,$205,$206,$207,$208,$209,$210,$211,$212,$213,$214,$215,$216,$217,$218,$219,$220,$221,$222,$223,$224,$225,$226,$227,$228,$229,$230,$231,$232,$233,$234,$235,$236,$237,$238,$239,$240,$241,$242,$243,$244,$245,$246,$247,$248,$249,$250,$251,$252,$253,$254,$255,$256,$257,$258,$259,$260,$261,$262,$263,$264,$265,$266,$267,$268,$269,$270,$271,$272,$273,$274,$275,$276,$277,$278,$279,$280,$281,$282,$283,$284,$285,$286,$287,$288,$289,$290,$291,$292,$293,$294,$295,$296,$297,$298,$299,$300,$301,$302,$303,$304,$305,$306,$307,$308,$309,$310,$311,$312,$313,$314,$315,$316,$317,$318,$319,$320,$321,$322,$323,$324,$325,$326,$327,$328,$329,$330,$331,$332,$333,$334,$335,$336,$337,$338,$339,$340,$341,$342,$343,$344,$345,$346,$347,$348,$349,$350,$351,$352,$353,$354,$355,$356,$357,$358,$359,$360,$361,$362,$363,$364,$365,$366,$367,$368,$369,$370,$371,$372,$373,$374,$375,$376,$377,$378,$379,$380,$381,$382,$383,$384,$385,$386,$387,$388,$389,$390,$391,$392,$393,$394,$395,$396,$397,$398,$399,$400,$401,$402,$403,$404,$405,$406,$407,$408,$409,$410,$411,$412,$413,$414,$415,$416,$417,$418,$419,$420,$421,$422,$423,$424,$425,$426,$427,$428,$429,$430,$431,$432,$433,$434,$435,$436,$437,$438,$439,$440,$441,$442,$443,$444,$445,$446,$447,$448,$449,$450,$451,$452,$453,$454,$455,$456,$457,$458,$459,$460,$461,$462,$463,$464,$465,$466,$467,$468,$469,$470,$471,$472,$473,$474,$475,$476,$477,$478,$479,$480,$481,$482,$483,$484,$485,$486,$487,$488,$489,$490,$491,$492,$493,$494,$495,$496,$497,$498,$499,$500,$501,$502,$503,$504,$505,$506,$507,$508,$509,$510,$511,$512,$513,$514,$515,$516,$517,$518,$519,$520,$521,$522,$523,$524,$525,$526,$527,$528,$529,$530,$531,$532,$533,$534,$535,$536,$537,$538,$539,$540,$541,$542,$543,$544,$545,$546,$547,$548,$549,$550,$551,$552,$553,$554,$555,$556,$557,$558,$559,$560,$561,$562,$563,$564,$565,$566,$567,$568,$569,$570,$571,$572,$573,$574,$575,$576,$577,$578,$579,$580,$581,$582,$583,$584,$585,$586,$587,$588,$589,$590,$591,$592,$593,$594,$595,$596,$597,$598,$599,$600,$601,$602,$603,$604,$605,$606,$607,$608,$609,$610,$611,$612,$613,$614,$615,$616,$617,$618,$619,$620,$621,$622,$623,$624,$625,$626,$627,$628,$629,$630,$631,$632,$633,$634,$635,$636,$637,$638,$639,$640,$641,$642,$643,$644,$645,$646,$647,$648,$649,$650,$651,$652,$653,$654,$655,$656,$657,$658,$659,$660,$661,$662,$663,$664,$665,$666,$667,$668,$669,$670,$671,$672,$673,$674,$675,$676,$677,$678,$679,$680,$681,$682,$683,$684,$685,$686,$687,$688,$689,$690,$691,$692,$693,$694,$695,$696,$697,$698,$699,$700,$701,$702,$703,$704,$705,$706,$707,$708,$709,$710,$711,$712,$713,$714,$715,$716,$717,$718,$719,$720,$721,$722,$723,$724,$725,$726,$727,$728,$729,$730,$731,$732,$733,$734,$735,$736,$737,$738,$739,$740,$741,$742,$743,$744,$745,$746,$747,$748,$749,$750,$751,$752,$753,$754,$755,$756,$757,$758,$759,$760,$761,$762,$763,$764,$765,$766,$767,$768,$769,$770,$771,$772,$773,$774,$775,$776,$777,$778,$779,$780,$781,$782,$783,$784,$785,$786,$787,$788,$789,$790,$791,$792,$793,$794,$795,$796,$797,$798,$799,$800,$801,$802,$803,$804,$805,$806,$807,$808,$809,$810,$811,$812,$813,$814,$815,$816,$817,$818,$819,$820,$821,$822,$823,$824,$825,$826,$827,$828,$829,$830,$831,$832,$833,$834,$835,$836,$837,$838,$839,$840,$841,$842,$843,$844,$845,$846,$847,$848,$849,$850,$851,$852,$853,$854,$855,$856,$857,$858,$859,$860,$861,$862,$863,$864,$865,$866,$867,$868,$869,$870,$871,$872,$873,$874,$875,$876,$877,$878,$879,$880,$881,$882,$883,$884,$885,$886,$887,$888,$889,$890,$891,$892,$893,$894,$895,$896,$897,$898,$899,$900,$901,$902,$903,$904,$905,$906,$907,$908,$909,$910,$911,$912,$913,$914,$915,$916,$917,$918,$919,$920,$921,$922,$923,$924,$925,$926,$927,$928,$929,$930,$931,$932,$933,$934,$935,$936,$937,$938,$939,$940,$941,$942,$943,$944,$945,$946,$947,$948,$949,$950,$951,$952,$953,$954,$955,$956,$957,$958,$959,$960,$961,$962,$963,$964,$965,$966,$967,$968,$969,$970,$971,$972,$973,$974,$975,$976,$977,$978,$979,$980,$981,$982,$983,$984,$985,$986,$987,$988,$989,$990,$991,$992,$993,$994,$995,$996,$997,$998,$999,$1000,$1001,$1002,$1003,$1004,$1005,$1006,$1007,$1008,$1009,$1010,$1011,$1012,$1013,$1014,$1015,$1016,$1017,$1018,$1019,$1020,$1021,$1022,$1023,$1024,$1025)<br>        AND r."modelVersionId" BETWEEN $1026 AND $1027<br>      GROUP BY r."modelVersionId", tf.timeframe<br>      ON CONFLICT ("modelVersionId", timeframe) DO UPDATE<br>        SET "thumbsUpCount" = EXCLUDED."thumbsUpCount", "thumbsDownCount" = EXCLUDED."thumbsDownCount", "updatedAt" = now()<br>``` |     |     |
| 3 min < 0.1% | 174,249 ms | 1 civitai |
| ```pgsql<br>WITH target AS MATERIALIZED (<br>        SELECT *<br>        FROM (<br>          SELECT *,<br>          ROW_NUMBER() OVER (<br>              PARTITION BY ci."collectionId"<br>              ORDER BY ci.id<br>            ) AS idx<br>          FROM "CollectionItem" ci<br>          WHERE ci.status = $29<br>            AND ci."collectionId" IN ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12,$13,$14,$15,$16,$17,$18,$19,$20,$21,$22,$23,$24,$25,$26,$27,$28)<br>        ) t<br>        WHERE idx <= $30<br>      ), imageItemImage AS MATERIALIZED (<br>        SELECT<br>          i.id,<br>          <br>    jsonb_build_object(<br>        $31, i."id",<br>        $32, i."index",<br>        $33, i."postId",<br>        $34, i."name",<br>        $35, i."url",<br>        $36, i."nsfwLevel",<br>        $37, i."width",<br>        $38, i."height",<br>        $39, i."hash",<br>        $40, i."createdAt",<br>        $41, i."mimeType",<br>        $42, i."scannedAt",<br>        $43, i."type",<br>        $44, i."userId",<br>        $45, i."meta"<br>      ) image<br>  <br>        FROM "Image" i<br>        WHERE i.id IN (SELECT "imageId" FROM target WHERE "imageId" IS NOT NULL)<br>          AND i."ingestion" = $46<br>          AND i."needsReview" IS NULL<br>      ), postItemImage AS MATERIALIZED (<br>        SELECT * FROM (<br>            SELECT<br>              i."postId" id,<br>              <br>    jsonb_build_object(<br>        $47, i."id",<br>        $48, i."index",<br>        $49, i."postId",<br>        $50, i."name",<br>        $51, i."url",<br>        $52, i."nsfwLevel",<br>        $53, i."width",<br>        $54, i."height",<br>        $55, i."hash",<br>        $56, i."createdAt",<br>        $57, i."mimeType",<br>        $58, i."scannedAt",<br>        $59, i."type",<br>        $60, i."userId",<br>        $61, i."meta"<br>      ) image<br>  ,<br>              ROW_NUMBER() OVER (PARTITION BY i."postId" ORDER BY i.index) rn<br>            FROM "Image" i<br>            WHERE i."postId" IN (SELECT "postId" FROM target WHERE "postId" IS NOT NULL)<br>              AND i."ingestion" = $62<br>              AND i."needsReview" IS NULL<br>        ) t<br>        WHERE t.rn = $63<br>      ), modelItemImage AS MATERIALIZED (<br>        SELECT * FROM (<br>            SELECT<br>              m.id,<br>              <br>    jsonb_build_object(<br>        $64, i."id",<br>        $65, i."index",<br>        $66, i."postId",<br>        $67, i."name",<br>        $68, i."url",<br>        $69, i."nsfwLevel",<br>        $70, i."width",<br>        $71, i."height",<br>        $72, i."hash",<br>        $73, i."createdAt",<br>        $74, i."mimeType",<br>        $75, i."scannedAt",<br>        $76, i."type",<br>        $77, i."userId",<br>        $78, i."meta"<br>      ) image<br>  ,<br>              ROW_NUMBER() OVER (PARTITION BY m.id ORDER BY mv.index, i."postId", i.index) rn<br>            FROM "Image" i<br>            JOIN "Post" p ON p.id = i."postId"<br>            JOIN "ModelVersion" mv ON mv.id = p."modelVersionId"<br>            JOIN "Model" m ON mv."modelId" = m.id AND m."userId" = p."userId"<br>            WHERE m."id" IN (SELECT "modelId" FROM target WHERE "modelId" IS NOT NULL)<br>                AND i."ingestion" = $79<br>                AND i."needsReview" IS NULL<br>        ) t<br>        WHERE t.rn = $80<br>      ), articleItemImage as MATERIALIZED (<br>          SELECT a.id, a.cover image FROM "Article" a<br>          WHERE a.id IN (SELECT "articleId" FROM target)<br>      )<br>      SELECT<br>          target."collectionId" id,<br>          COALESCE(<br>            (SELECT image FROM imageItemImage iii WHERE iii.id = target."imageId"),<br>            (SELECT image FROM postItemImage pii WHERE pii.id = target."postId"),<br>            (SELECT image FROM modelItemImage mii WHERE mii.id = target."modelId"),<br>            $81<br>          ) image,<br>          (SELECT image FROM articleItemImage aii WHERE aii.id = target."articleId") src<br>      FROM target<br>``` |     |     |
| 3 min < 0.1% | 160,123 ms | 1 civitai |
| ```pgsql<br>-- update tag engagement metrics<br>      INSERT INTO "UserMetric" ("userId", timeframe, "followerCount", "hiddenCount")<br>      SELECT<br>        "targetUserId",<br>        tf.timeframe,<br>        <br>    SUM(CASE<br>      WHEN NOT (e.type = $1) THEN $2<br>      WHEN tf.timeframe = $3 THEN $4<br>      WHEN tf.timeframe = $5 AND e."createdAt" > (NOW() - interval $6) THEN $7<br>      WHEN tf.timeframe = $8 AND e."createdAt" > (NOW() - interval $9) THEN $10<br>      WHEN tf.timeframe = $11 AND e."createdAt" > (NOW() - interval $12) THEN $13<br>      WHEN tf.timeframe = $14 AND e."createdAt" > (NOW() - interval $15) THEN $16<br>      ELSE $17<br>    END)<br>   "followerCount",<br>        <br>    SUM(CASE<br>      WHEN NOT (e.type = $18) THEN $19<br>      WHEN tf.timeframe = $20 THEN $21<br>      WHEN tf.timeframe = $22 AND e."createdAt" > (NOW() - interval $23) THEN $24<br>      WHEN tf.timeframe = $25 AND e."createdAt" > (NOW() - interval $26) THEN $27<br>      WHEN tf.timeframe = $28 AND e."createdAt" > (NOW() - interval $29) THEN $30<br>      WHEN tf.timeframe = $31 AND e."createdAt" > (NOW() - interval $32) THEN $33<br>      ELSE $34<br>    END)<br>   "hiddenCount"<br>      FROM "UserEngagement" e<br>      CROSS JOIN (SELECT unnest(enum_range($35::"MetricTimeframe")) AS timeframe) tf<br>      WHERE "targetUserId" IN ($36,$37,$38,$39,$40,$41,$42,$43,$44,$45,$46,$47,$48,$49,$50,$51,$52,$53,$54,$55,$56,$57,$58,$59,$60,$61,$62,$63,$64,$65,$66,$67,$68,$69,$70,$71,$72,$73,$74,$75,$76,$77,$78,$79,$80,$81,$82,$83,$84,$85,$86,$87,$88,$89,$90,$91,$92,$93,$94,$95,$96,$97,$98,$99,$100,$101,$102,$103,$104,$105,$106,$107,$108,$109,$110,$111,$112,$113,$114,$115,$116,$117,$118,$119,$120,$121,$122,$123,$124,$125,$126,$127,$128,$129,$130,$131,$132,$133,$134,$135,$136,$137,$138,$139,$140,$141,$142,$143,$144,$145,$146,$147,$148,$149,$150,$151,$152,$153)<br>      GROUP BY "targetUserId", tf.timeframe<br>      ON CONFLICT ("userId", timeframe) DO UPDATE<br>        SET "followerCount" = EXCLUDED."followerCount", "hiddenCount" = EXCLUDED."hiddenCount", "updatedAt" = NOW()<br>``` |     |     |
| 3 min < 0.1% | 155,100 ms | 1 civitai |
| ```pgsql<br>-- update model rating metrics<br>      INSERT INTO "ModelMetric" ("modelId", timeframe, "thumbsUpCount", "thumbsDownCount")<br>      SELECT<br>        r."modelId",<br>        tf.timeframe,<br>        <br>    COUNT(DISTINCT CASE<br>      WHEN NOT (recommended) THEN $1<br>      WHEN tf.timeframe = $2 THEN r."userId"<br>      WHEN tf.timeframe = $3 AND r."createdAt" > (NOW() - interval $4) THEN r."userId"<br>      WHEN tf.timeframe = $5 AND r."createdAt" > (NOW() - interval $6) THEN r."userId"<br>      WHEN tf.timeframe = $7 AND r."createdAt" > (NOW() - interval $8) THEN r."userId"<br>      WHEN tf.timeframe = $9 AND r."createdAt" > (NOW() - interval $10) THEN r."userId"<br>      ELSE $11<br>    END)<br>   "thumbsUpCount",<br>        <br>    COUNT(DISTINCT CASE<br>      WHEN NOT (NOT recommended) THEN $12<br>      WHEN tf.timeframe = $13 THEN r."userId"<br>      WHEN tf.timeframe = $14 AND r."createdAt" > (NOW() - interval $15) THEN r."userId"<br>      WHEN tf.timeframe = $16 AND r."createdAt" > (NOW() - interval $17) THEN r."userId"<br>      WHEN tf.timeframe = $18 AND r."createdAt" > (NOW() - interval $19) THEN r."userId"<br>      WHEN tf.timeframe = $20 AND r."createdAt" > (NOW() - interval $21) THEN r."userId"<br>      ELSE $22<br>    END)<br>   "thumbsDownCount"<br>      FROM "ResourceReview" r<br>      CROSS JOIN ( SELECT unnest(enum_range($23::"MetricTimeframe")) AS timeframe ) tf<br>      WHERE r.exclude = $24<br>        AND r."tosViolation" = $25<br>        AND r."modelId" IN ($26,$27,$28,$29,$30,$31,$32,$33,$34,$35,$36,$37,$38,$39,$40,$41,$42,$43,$44,$45,$46,$47,$48,$49,$50,$51,$52,$53,$54,$55,$56,$57,$58,$59,$60,$61,$62,$63,$64,$65,$66,$67,$68,$69,$70,$71,$72,$73,$74,$75,$76,$77,$78,$79,$80,$81,$82,$83,$84,$85,$86,$87,$88,$89,$90,$91,$92,$93,$94,$95,$96,$97,$98,$99,$100,$101,$102,$103,$104,$105,$106,$107,$108,$109,$110,$111,$112,$113,$114,$115,$116,$117,$118,$119,$120,$121,$122,$123,$124,$125,$126,$127,$128,$129,$130,$131,$132,$133,$134,$135,$136,$137,$138,$139,$140,$141,$142,$143,$144,$145,$146,$147,$148,$149,$150,$151,$152,$153,$154,$155,$156,$157,$158,$159,$160,$161,$162,$163,$164,$165,$166,$167,$168,$169,$170,$171,$172,$173,$174,$175,$176,$177,$178,$179,$180,$181,$182,$183,$184,$185,$186,$187,$188,$189,$190,$191,$192,$193,$194,$195,$196,$197,$198,$199,$200,$201,$202,$203,$204,$205,$206,$207,$208,$209,$210,$211,$212,$213,$214,$215,$216,$217,$218,$219,$220,$221,$222,$223,$224,$225,$226,$227,$228,$229,$230,$231,$232,$233,$234,$235,$236,$237,$238,$239,$240,$241,$242,$243,$244,$245,$246,$247,$248,$249,$250,$251,$252,$253,$254,$255,$256,$257,$258,$259,$260,$261,$262,$263,$264,$265,$266,$267,$268,$269,$270,$271,$272,$273,$274,$275,$276,$277,$278,$279,$280,$281,$282,$283,$284,$285,$286,$287,$288,$289,$290,$291,$292,$293,$294,$295,$296,$297,$298,$299,$300,$301,$302,$303,$304,$305,$306,$307,$308,$309,$310,$311,$312,$313,$314,$315,$316,$317,$318,$319,$320,$321,$322,$323,$324,$325,$326,$327,$328,$329,$330,$331,$332,$333,$334,$335,$336,$337,$338,$339,$340,$341,$342,$343,$344,$345,$346,$347,$348,$349,$350,$351,$352,$353,$354,$355,$356,$357,$358,$359,$360,$361,$362,$363,$364,$365,$366,$367,$368,$369,$370,$371,$372,$373,$374,$375,$376,$377,$378,$379,$380,$381,$382,$383,$384,$385,$386,$387,$388,$389,$390,$391,$392,$393,$394,$395,$396)<br>      GROUP BY r."modelId", tf.timeframe<br>      ON CONFLICT ("modelId", timeframe) DO UPDATE<br>        SET "thumbsUpCount" = EXCLUDED."thumbsUpCount", "thumbsDownCount" = EXCLUDED."thumbsDownCount", "updatedAt" = now()<br>``` |     |     |
| 325 min < 0.1% | 131,829 ms | 148 civitai |
| ```pgsql<br>SELECT "public"."ChatMessage"."id", "public"."ChatMessage"."createdAt", "public"."ChatMessage"."content", "public"."ChatMessage"."contentType"::text, "public"."ChatMessage"."chatId" FROM "public"."ChatMessage" WHERE ("public"."ChatMessage"."contentType" <> CAST($1::text AS "public"."ChatMessageType") AND "public"."ChatMessage"."chatId" IN ($2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12,$13,$14,$15,$16,$17,$18,$19,$20,$21,$22,$23,$24,$25,$26,$27,$28,$29,$30,$31,$32,$33,$34,$35,$36,$37,$38,$39,$40,$41,$42,$43,$44,$45,$46,$47,$48,$49,$50,$51,$52,$53,$54,$55,$56,$57,$58,$59,$60,$61,$62,$63,$64,$65,$66,$67,$68,$69,$70,$71,$72,$73,$74,$75,$76,$77,$78,$79,$80,$81,$82,$83,$84,$85,$86,$87,$88,$89,$90,$91,$92,$93,$94,$95,$96,$97,$98,$99,$100,$101,$102,$103,$104,$105,$106,$107,$108,$109,$110,$111,$112,$113,$114,$115,$116,$117,$118,$119,$120,$121,$122,$123,$124,$125,$126,$127,$128,$129,$130,$131,$132,$133,$134,$135,$136,$137,$138,$139,$140,$141,$142,$143,$144,$145,$146,$147,$148,$149,$150,$151,$152,$153,$154,$155,$156,$157,$158,$159,$160,$161,$162,$163,$164,$165,$166,$167,$168,$169,$170,$171,$172,$173,$174,$175,$176,$177,$178,$179,$180,$181,$182,$183,$184,$185,$186,$187,$188,$189,$190,$191,$192,$193,$194,$195,$196,$197,$198,$199,$200,$201,$202,$203,$204,$205,$206,$207,$208,$209,$210,$211,$212,$213,$214,$215,$216,$217,$218,$219,$220,$221,$222,$223,$224,$225,$226,$227,$228,$229,$230,$231,$232,$233,$234,$235,$236,$237,$238,$239,$240,$241,$242,$243,$244,$245,$246,$247,$248,$249,$250,$251,$252,$253,$254,$255,$256,$257,$258,$259,$260,$261,$262,$263,$264,$265,$266,$267,$268,$269,$270,$271,$272,$273,$274,$275,$276,$277,$278,$279,$280,$281,$282,$283,$284,$285,$286,$287,$288,$289,$290,$291,$292,$293,$294,$295,$296,$297,$298,$299,$300,$301,$302,$303,$304,$305,$306,$307,$308,$309,$310,$311,$312,$313,$314,$315,$316,$317,$318,$319,$320,$321,$322,$323,$324,$325,$326,$327,$328,$329,$330,$331,$332,$333,$334,$335,$336,$337,$338,$339,$340,$341,$342,$343,$344,$345,$346,$347,$348,$349,$350,$351,$352,$353,$354,$355,$356,$357,$358,$359,$360,$361,$362,$363,$364,$365,$366,$367,$368,$369,$370,$371,$372,$373,$374,$375,$376,$377,$378,$379,$380,$381,$382,$383,$384,$385,$386,$387,$388,$389,$390,$391,$392,$393,$394,$395,$396,$397,$398,$399,$400,$401,$402,$403,$404,$405,$406,$407,$408,$409,$410,$411,$412,$413,$414,$415,$416,$417,$418,$419,$420,$421,$422,$423,$424,$425,$426,$427,$428,$429,$430,$431,$432,$433,$434,$435,$436,$437,$438,$439,$440,$441,$442,$443,$444,$445,$446,$447,$448,$449,$450,$451,$452,$453,$454,$455,$456,$457,$458,$459,$460,$461,$462,$463,$464,$465,$466,$467,$468,$469,$470,$471,$472,$473,$474,$475,$476,$477,$478,$479,$480,$481,$482,$483,$484,$485,$486,$487,$488,$489,$490,$491,$492,$493,$494,$495,$496,$497,$498,$499,$500,$501,$502,$503,$504,$505,$506,$507,$508,$509,$510,$511,$512,$513,$514,$515,$516,$517,$518,$519,$520,$521,$522,$523,$524,$525,$526,$527,$528,$529,$530,$531,$532,$533,$534,$535,$536,$537,$538)) ORDER BY "public"."ChatMessage"."createdAt" DESC OFFSET $539<br>```<br><br>`Covered by index on (chatId, userId) Rows: 2339271 Row progression: 2339271, 82, 41  Row estimates - chatId (=): 82 - contentType (<>): 1169636 - createdAt (sort): 1  Existing indexes - id PRIMARY - chatId, userId` |     |     |
| 1,024 min 0.1% | 114,386 ms | 537 civitai |
| ```pgsql<br>-- update tag engagement metrics<br>      INSERT INTO "TagMetric" ("tagId", timeframe, "followerCount", "hiddenCount")<br>      SELECT<br>        "tagId",<br>        tf.timeframe,<br>        <br>    SUM(CASE<br>      WHEN NOT (e.type = $1) THEN $2<br>      WHEN tf.timeframe = $3 THEN $4<br>      WHEN tf.timeframe = $5 AND e."createdAt" > (NOW() - interval $6) THEN $7<br>      WHEN tf.timeframe = $8 AND e."createdAt" > (NOW() - interval $9) THEN $10<br>      WHEN tf.timeframe = $11 AND e."createdAt" > (NOW() - interval $12) THEN $13<br>      WHEN tf.timeframe = $14 AND e."createdAt" > (NOW() - interval $15) THEN $16<br>      ELSE $17<br>    END)<br>   "followerCount",<br>        <br>    SUM(CASE<br>      WHEN NOT (e.type = $18) THEN $19<br>      WHEN tf.timeframe = $20 THEN $21<br>      WHEN tf.timeframe = $22 AND e."createdAt" > (NOW() - interval $23) THEN $24<br>      WHEN tf.timeframe = $25 AND e."createdAt" > (NOW() - interval $26) THEN $27<br>      WHEN tf.timeframe = $28 AND e."createdAt" > (NOW() - interval $29) THEN $30<br>      WHEN tf.timeframe = $31 AND e."createdAt" > (NOW() - interval $32) THEN $33<br>      ELSE $34<br>    END)<br>   "hiddenCount"<br>      FROM "TagEngagement" e<br>      CROSS JOIN (SELECT unnest(enum_range($35::"MetricTimeframe")) AS timeframe) tf<br>      WHERE "tagId" IN ($36)<br>      GROUP BY "tagId", tf.timeframe<br>      ON CONFLICT ("tagId", timeframe) DO UPDATE<br>        SET "followerCount" = EXCLUDED."followerCount", "hiddenCount" = EXCLUDED."hiddenCount", "updatedAt" = NOW()<br>``` |     |     |
| 2 min < 0.1% | 100,048 ms | 1 civitai |
| ```pgsql<br>UPDATE "PostMetric" pm<br>          SET "ageGroup" = $1::"MetricTimeframe"<br>          WHERE pm."postId" IN ($2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12,$13,$14,$15,$16,$17,$18,$19,$20,$21,$22,$23,$24,$25,$26,$27,$28,$29,$30,$31,$32,$33,$34,$35,$36,$37,$38,$39,$40,$41,$42,$43,$44,$45,$46,$47,$48,$49,$50,$51,$52,$53,$54,$55,$56,$57,$58,$59,$60,$61,$62,$63,$64,$65,$66,$67,$68,$69,$70,$71,$72,$73,$74,$75,$76,$77,$78,$79,$80,$81,$82,$83,$84,$85,$86,$87,$88,$89,$90,$91,$92,$93,$94,$95,$96,$97,$98,$99,$100,$101,$102,$103,$104,$105,$106,$107,$108,$109,$110,$111,$112,$113,$114,$115,$116,$117,$118,$119,$120,$121,$122,$123,$124,$125,$126,$127,$128,$129,$130,$131,$132,$133,$134,$135,$136,$137,$138,$139,$140,$141,$142,$143,$144,$145,$146,$147,$148,$149,$150,$151,$152,$153,$154,$155,$156,$157,$158,$159,$160,$161,$162,$163,$164,$165,$166,$167,$168,$169,$170,$171,$172,$173,$174,$175,$176,$177,$178,$179,$180,$181,$182,$183,$184,$185,$186,$187,$188,$189,$190,$191,$192,$193,$194,$195,$196,$197,$198,$199,$200,$201,$202,$203,$204,$205,$206,$207,$208,$209,$210,$211,$212,$213,$214,$215,$216,$217,$218,$219,$220,$221,$222,$223,$224,$225,$226,$227,$228,$229,$230,$231,$232,$233,$234,$235,$236,$237,$238,$239,$240,$241,$242,$243,$244,$245,$246,$247,$248,$249,$250,$251,$252,$253,$254,$255,$256,$257,$258,$259,$260,$261,$262,$263,$264,$265,$266,$267,$268,$269,$270,$271,$272,$273,$274,$275,$276,$277,$278,$279,$280,$281,$282,$283,$284,$285,$286,$287,$288,$289,$290,$291,$292,$293,$294,$295,$296,$297,$298,$299,$300,$301,$302,$303,$304,$305,$306,$307,$308,$309,$310,$311,$312,$313,$314,$315,$316,$317,$318,$319,$320,$321,$322,$323,$324,$325,$326,$327,$328,$329,$330,$331,$332,$333,$334,$335,$336,$337,$338,$339,$340,$341,$342,$343,$344,$345,$346,$347,$348,$349,$350,$351,$352,$353,$354,$355,$356,$357,$358,$359,$360,$361,$362,$363,$364,$365,$366,$367,$368,$369,$370,$371,$372,$373,$374,$375,$376,$377,$378,$379,$380,$381,$382,$383,$384,$385,$386,$387,$388,$389,$390,$391,$392,$393,$394,$395,$396,$397,$398,$399,$400,$401,$402,$403,$404,$405,$406,$407,$408,$409,$410,$411,$412,$413,$414,$415,$416,$417,$418,$419,$420,$421,$422,$423,$424,$425,$426,$427,$428,$429,$430,$431,$432,$433,$434,$435,$436,$437,$438,$439,$440,$441,$442,$443,$444,$445,$446,$447,$448,$449,$450,$451,$452,$453,$454,$455,$456,$457,$458,$459,$460,$461,$462,$463,$464,$465,$466,$467,$468,$469,$470,$471,$472,$473,$474,$475,$476,$477,$478,$479,$480,$481,$482,$483,$484,$485,$486,$487,$488,$489,$490,$491,$492,$493,$494,$495,$496,$497,$498,$499,$500,$501,$502,$503,$504,$505,$506,$507,$508,$509,$510,$511,$512,$513,$514,$515,$516,$517,$518,$519,$520,$521,$522,$523,$524,$525,$526,$527,$528,$529,$530,$531,$532,$533,$534,$535,$536,$537,$538,$539,$540,$541,$542,$543,$544,$545,$546,$547,$548,$549,$550,$551,$552,$553,$554,$555,$556,$557,$558,$559,$560,$561,$562,$563,$564,$565,$566,$567,$568,$569,$570,$571,$572,$573,$574,$575,$576,$577,$578,$579,$580,$581,$582,$583,$584,$585,$586,$587,$588,$589,$590,$591,$592,$593,$594,$595,$596,$597,$598,$599,$600,$601,$602,$603,$604,$605,$606,$607,$608,$609,$610,$611,$612,$613,$614,$615,$616,$617,$618,$619,$620,$621,$622,$623,$624,$625,$626,$627,$628,$629,$630,$631,$632,$633,$634,$635,$636,$637,$638,$639,$640,$641,$642,$643,$644,$645,$646,$647,$648,$649,$650,$651,$652,$653,$654,$655,$656,$657,$658,$659,$660,$661,$662,$663,$664,$665,$666,$667,$668,$669,$670,$671,$672,$673,$674,$675,$676,$677,$678,$679,$680,$681,$682,$683,$684,$685,$686,$687,$688,$689,$690,$691,$692,$693,$694,$695,$696,$697,$698,$699,$700,$701,$702,$703,$704,$705,$706,$707,$708,$709,$710,$711,$712,$713,$714,$715,$716,$717,$718,$719,$720,$721,$722,$723,$724,$725,$726,$727,$728,$729,$730,$731,$732,$733,$734,$735,$736,$737,$738,$739,$740,$741,$742,$743,$744,$745,$746,$747,$748,$749,$750,$751,$752,$753,$754,$755,$756,$757,$758,$759,$760,$761,$762,$763,$764,$765,$766,$767,$768,$769,$770,$771,$772,$773,$774,$775,$776,$777,$778,$779,$780,$781,$782,$783,$784,$785,$786,$787,$788,$789,$790,$791,$792,$793,$794,$795,$796,$797,$798,$799,$800,$801,$802,$803,$804,$805,$806,$807,$808,$809,$810,$811,$812,$813,$814,$815,$816,$817,$818,$819,$820,$821,$822,$823,$824,$825,$826,$827,$828,$829,$830,$831,$832,$833,$834,$835,$836,$837,$838,$839,$840,$841,$842,$843,$844,$845,$846,$847,$848,$849,$850,$851,$852,$853,$854,$855,$856,$857,$858,$859,$860,$861,$862,$863,$864,$865,$866,$867,$868,$869,$870,$871,$872,$873,$874,$875,$876,$877,$878,$879,$880,$881,$882,$883,$884,$885,$886,$887,$888,$889,$890,$891,$892,$893,$894,$895,$896,$897,$898,$899,$900,$901,$902,$903,$904,$905,$906,$907,$908,$909,$910,$911,$912,$913,$914,$915,$916,$917,$918,$919,$920,$921,$922,$923,$924,$925,$926,$927,$928,$929,$930,$931,$932,$933,$934,$935,$936,$937,$938,$939,$940,$941,$942,$943,$944,$945,$946,$947,$948,$949,$950,$951,$952,$953,$954,$955,$956,$957,$958,$959,$960,$961,$962,$963,$964,$965,$966,$967,$968,$969,$970,$971,$972,$973,$974,$975,$976,$977,$978,$979,$980,$981,$982,$983,$984,$985,$986,$987,$988,$989,$990,$991,$992,$993,$994,$995,$996,$997,$998,$999,$1000,$1001,$1002,$1003,$1004,$1005,$1006,$1007,$1008,$1009,$1010,$1011,$1012,$1013,$1014,$1015,$1016,$1017,$1018,$1019,$1020,$1021,$1022,$1023,$1024,$1025,$1026,$1027,$1028,$1029,$1030,$1031,$1032,$1033,$1034,$1035,$1036,$1037,$1038,$1039,$1040,$1041,$1042,$1043,$1044,$1045,$1046,$1047,$1048,$1049,$1050,$1051,$1052,$1053,$1054,$1055,$1056,$1057,$1058,$1059,$1060,$1061,$1062,$1063,$1064,$1065,$1066,$1067,$1068,$1069,$1070,$1071,$1072,$1073,$1074,$1075,$1076,$1077,$1078,$1079,$1080,$1081,$1082,$1083,$1084,$1085,$1086,$1087,$1088,$1089,$1090,$1091,$1092,$1093,$1094,$1095,$1096,$1097,$1098,$1099,$1100,$1101,$1102,$1103,$1104,$1105,$1106,$1107,$1108,$1109,$1110,$1111,$1112,$1113,$1114,$1115,$1116,$1117,$1118,$1119,$1120,$1121,$1122,$1123,$1124,$1125,$1126,$1127,$1128,$1129,$1130,$1131,$1132,$1133,$1134,$1135,$1136,$1137,$1138,$1139,$1140,$1141,$1142,$1143,$1144,$1145,$1146,$1147,$1148,$1149,$1150,$1151,$1152,$1153,$1154,$1155,$1156,$1157,$1158,$1159,$1160,$1161,$1162,$1163,$1164,$1165,$1166,$1167,$1168,$1169,$1170,$1171,$1172,$1173,$1174,$1175,$1176,$1177,$1178,$1179,$1180,$1181,$1182,$1183,$1184,$1185,$1186,$1187,$1188,$1189,$1190,$1191,$1192,$1193,$1194,$1195,$1196,$1197,$1198,$1199,$1200,$1201,$1202,$1203,$1204,$1205,$1206,$1207,$1208,$1209,$1210,$1211,$1212,$1213,$1214,$1215,$1216,$1217,$1218,$1219,$1220,$1221,$1222,$1223,$1224,$1225,$1226,$1227,$1228,$1229,$1230,$1231,$1232,$1233,$1234,$1235,$1236,$1237,$1238,$1239,$1240,$1241,$1242,$1243,$1244,$1245,$1246,$1247,$1248,$1249,$1250,$1251,$1252,$1253,$1254,$1255,$1256,$1257,$1258,$1259,$1260,$1261,$1262,$1263,$1264,$1265,$1266,$1267,$1268,$1269,$1270,$1271,$1272,$1273,$1274,$1275,$1276,$1277,$1278,$1279,$1280,$1281,$1282,$1283,$1284,$1285,$1286,$1287,$1288,$1289,$1290,$1291,$1292,$1293,$1294,$1295,$1296,$1297,$1298,$1299,$1300,$1301,$1302,$1303,$1304,$1305,$1306,$1307,$1308,$1309,$1310,$1311,$1312,$1313,$1314,$1315,$1316,$1317,$1318,$1319,$1320,$1321,$1322,$1323,$1324,$1325,$1326,$1327,$1328,$1329,$1330,$1331,$1332,$1333,$1334,$1335,$1336,$1337,$1338,$1339,$1340,$1341,$1342,$1343,$1344,$1345,$1346,$1347,$1348,$1349,$1350,$1351,$1352,$1353,$1354,$1355,$1356,$1357,$1358,$1359,$1360,$1361,$1362,$1363,$1364,$1365,$1366,$1367,$1368,$1369,$1370,$1371,$1372,$1373,$1374,$1375,$1376,$1377,$1378,$1379,$1380,$1381,$1382,$1383,$1384,$1385,$1386,$1387,$1388,$1389,$1390,$1391,$1392,$1393,$1394,$1395,$1396,$1397,$1398,$1399,$1400,$1401,$1402,$1403,$1404,$1405,$1406,$1407,$1408,$1409,$1410,$1411,$1412,$1413,$1414,$1415,$1416,$1417,$1418,$1419,$1420,$1421,$1422,$1423,$1424,$1425,$1426,$1427,$1428,$1429,$1430,$1431,$1432,$1433,$1434,$1435,$1436,$1437,$1438,$1439,$1440,$1441,$1442,$1443,$1444,$1445,$1446,$1447,$1448,$1449,$1450,$1451,$1452,$1453,$1454,$1455,$1456,$1457,$1458,$1459,$1460,$1461,$1462,$1463,$1464,$1465,$1466,$1467,$1468,$1469,$1470,$1471,$1472,$1473,$1474,$1475,$1476,$1477,$1478,$1479,$1480,$1481,$1482,$1483,$1484,$1485,$1486,$1487,$1488,$1489,$1490,$1491,$1492,$1493,$1494,$1495,$1496,$1497,$1498,$1499,$1500,$1501,$1502,$1503,$1504,$1505,$1506,$1507,$1508,$1509,$1510,$1511,$1512,$1513,$1514,$1515,$1516,$1517,$1518,$1519,$1520,$1521,$1522,$1523,$1524,$1525,$1526,$1527,$1528,$1529,$1530,$1531,$1532,$1533,$1534,$1535,$1536,$1537,$1538,$1539,$1540,$1541,$1542,$1543,$1544,$1545,$1546,$1547,$1548,$1549,$1550,$1551,$1552,$1553,$1554,$1555,$1556,$1557,$1558,$1559,$1560,$1561,$1562,$1563,$1564,$1565,$1566,$1567,$1568,$1569,$1570,$1571,$1572,$1573,$1574,$1575,$1576,$1577,$1578,$1579,$1580,$1581,$1582,$1583,$1584,$1585,$1586,$1587,$1588,$1589,$1590,$1591,$1592,$1593,$1594,$1595,$1596,$1597,$1598,$1599,$1600,$1601,$1602,$1603,$1604,$1605,$1606,$1607,$1608,$1609,$1610,$1611,$1612,$1613,$1614,$1615,$1616,$1617,$1618,$1619,$1620,$1621,$1622,$1623,$1624,$1625,$1626,$1627,$1628,$1629,$1630,$1631,$1632,$1633,$1634,$1635,$1636,$1637,$1638,$1639,$1640,$1641,$1642,$1643,$1644,$1645,$1646,$1647,$1648,$1649,$1650,$1651,$1652,$1653,$1654,$1655,$1656,$1657,$1658,$1659,$1660,$1661,$1662,$1663,$1664,$1665,$1666,$1667,$1668,$1669,$1670,$1671,$1672,$1673,$1674,$1675,$1676,$1677,$1678,$1679,$1680,$1681,$1682,$1683,$1684,$1685,$1686,$1687,$1688,$1689,$1690,$1691,$1692,$1693,$1694,$1695,$1696,$1697,$1698,$1699,$1700,$1701,$1702,$1703,$1704,$1705,$1706,$1707,$1708,$1709,$1710,$1711,$1712,$1713,$1714,$1715,$1716,$1717,$1718,$1719,$1720,$1721,$1722,$1723,$1724,$1725,$1726,$1727,$1728,$1729,$1730,$1731,$1732,$1733,$1734,$1735,$1736,$1737,$1738,$1739,$1740,$1741,$1742,$1743,$1744,$1745,$1746,$1747,$1748,$1749,$1750,$1751,$1752,$1753,$1754,$1755,$1756,$1757,$1758,$1759,$1760,$1761,$1762,$1763,$1764,$1765,$1766,$1767,$1768,$1769,$1770,$1771,$1772,$1773,$1774,$1775,$1776,$1777,$1778,$1779,$1780,$1781,$1782,$1783,$1784,$1785,$1786,$1787,$1788,$1789,$1790,$1791,$1792,$1793,$1794,$1795,$1796,$1797,$1798,$1799,$1800,$1801,$1802,$1803,$1804,$1805,$1806,$1807,$1808,$1809,$1810,$1811,$1812,$1813,$1814,$1815,$1816,$1817,$1818,$1819,$1820,$1821,$1822,$1823,$1824,$1825,$1826,$1827,$1828,$1829,$1830,$1831,$1832,$1833,$1834,$1<br>``` |     |     |
| 214 min < 0.1% | 86,302 ms | 149 civitai |
| ```pgsql<br>SELECT "public"."ChatMessage"."id", "public"."ChatMessage"."createdAt", "public"."ChatMessage"."content", "public"."ChatMessage"."contentType"::text, "public"."ChatMessage"."chatId" FROM "public"."ChatMessage" WHERE ("public"."ChatMessage"."contentType" <> CAST($1::text AS "public"."ChatMessageType") AND "public"."ChatMessage"."chatId" IN ($2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12,$13,$14,$15,$16,$17,$18,$19,$20,$21,$22,$23,$24,$25,$26,$27,$28,$29,$30,$31,$32,$33,$34,$35,$36,$37,$38,$39,$40,$41,$42,$43,$44,$45,$46,$47,$48,$49,$50,$51,$52,$53,$54,$55,$56,$57,$58,$59,$60,$61,$62,$63,$64,$65,$66,$67,$68,$69,$70,$71,$72,$73,$74,$75,$76,$77,$78,$79,$80,$81,$82,$83,$84,$85,$86,$87,$88,$89,$90,$91,$92,$93,$94,$95,$96,$97,$98,$99,$100,$101,$102,$103,$104,$105,$106,$107,$108,$109,$110,$111,$112,$113,$114,$115,$116,$117,$118,$119,$120,$121,$122,$123,$124,$125,$126,$127,$128,$129,$130,$131,$132,$133,$134,$135,$136,$137,$138,$139,$140,$141,$142,$143,$144,$145,$146,$147,$148,$149,$150,$151,$152,$153,$154,$155,$156,$157,$158,$159,$160,$161,$162,$163,$164,$165,$166,$167,$168,$169,$170,$171,$172,$173,$174,$175,$176,$177,$178,$179,$180,$181,$182,$183,$184,$185,$186,$187,$188,$189,$190,$191,$192,$193,$194,$195,$196,$197,$198,$199,$200,$201,$202,$203,$204,$205,$206,$207,$208,$209,$210,$211,$212,$213,$214,$215,$216,$217,$218,$219,$220,$221,$222,$223,$224,$225,$226,$227,$228,$229,$230,$231,$232,$233,$234,$235,$236,$237,$238,$239,$240,$241,$242,$243,$244,$245,$246,$247,$248,$249,$250,$251,$252,$253,$254,$255,$256,$257,$258,$259,$260,$261,$262,$263,$264,$265,$266,$267,$268,$269,$270,$271,$272,$273,$274,$275,$276,$277,$278,$279,$280,$281,$282,$283,$284,$285,$286,$287,$288,$289,$290,$291,$292,$293,$294,$295,$296,$297,$298,$299,$300,$301,$302,$303,$304,$305,$306,$307,$308,$309,$310,$311,$312,$313,$314,$315,$316,$317,$318,$319,$320,$321,$322,$323,$324,$325,$326,$327,$328,$329,$330,$331,$332,$333,$334,$335,$336,$337,$338,$339,$340,$341,$342,$343,$344,$345,$346,$347,$348,$349,$350,$351,$352,$353,$354,$355,$356,$357)) ORDER BY "public"."ChatMessage"."createdAt" DESC OFFSET $358<br>```<br><br>`Covered by index on (chatId, userId) Rows: 2339271 Row progression: 2339271, 82, 41  Row estimates - chatId (=): 82 - contentType (<>): 1169636 - createdAt (sort): 1  Existing indexes - id PRIMARY - chatId, userId` |     |     |
| 12,117 min 2% | 82,839 ms | 8,776 civitai |
| ```pgsql<br>UPDATE "CollectionItem" ci SET "randomId" = FLOOR(RANDOM() * $2)<br>    WHERE ci."collectionId" = $1<br>      AND ci."status" = $3<br>```<br><br>`Covered by index on (collectionId, postId" WHERE "postId" IS NOT NUL) Rows: 114046048 Row progression: 114046048, 2056, 685  Row estimates - collectionId (=): 2056 - status (=): 38015349  Existing indexes - id PRIMARY - addedById HASH - collectionId HASH - collectionId, articleId" WHERE "articleId" IS NOT NUL UNIQUE - collectionId, createdAt - collectionId, imageId" WHERE "imageId" IS NOT NUL UNIQUE - collectionId, modelId" WHERE "modelId" IS NOT NUL UNIQUE - collectionId, postId" WHERE "postId" IS NOT NUL UNIQUE - collectionId, randomId - createdAt - imageId HASH - modelId HASH - modelId, createdAt") INCLUDE ("addedById - postId - status` |     |     |
| 1 min < 0.1% | 73,116 ms | 1 civitai |
| ```pgsql<br>-- update collection item metrics<br>      INSERT INTO "CollectionMetric" ("collectionId", timeframe, "itemCount")<br>      SELECT<br>        "collectionId",<br>        tf.timeframe,<br>        <br>    SUM(CASE<br>      <br>      WHEN tf.timeframe = $1 THEN $2<br>      WHEN tf.timeframe = $3 AND "createdAt" > (NOW() - interval $4) THEN $5<br>      WHEN tf.timeframe = $6 AND "createdAt" > (NOW() - interval $7) THEN $8<br>      WHEN tf.timeframe = $9 AND "createdAt" > (NOW() - interval $10) THEN $11<br>      WHEN tf.timeframe = $12 AND "createdAt" > (NOW() - interval $13) THEN $14<br>      ELSE $15<br>    END)<br>   as "itemCount"<br>      FROM "CollectionItem"<br>      CROSS JOIN (SELECT unnest(enum_range($16::"MetricTimeframe")) AS timeframe) tf<br>      WHERE "collectionId" IN ($17,$18,$19,$20,$21,$22,$23,$24,$25,$26,$27,$28,$29,$30,$31,$32,$33,$34,$35,$36,$37,$38,$39,$40,$41,$42,$43,$44,$45,$46,$47,$48,$49,$50,$51,$52,$53,$54,$55,$56,$57,$58,$59,$60,$61,$62,$63,$64,$65,$66,$67,$68,$69,$70,$71,$72,$73,$74,$75,$76,$77,$78,$79,$80,$81,$82,$83,$84,$85,$86,$87,$88,$89,$90,$91,$92,$93,$94,$95,$96,$97,$98,$99,$100,$101,$102,$103,$104,$105,$106,$107,$108,$109,$110,$111,$112,$113,$114,$115,$116,$117,$118,$119,$120,$121,$122,$123,$124,$125,$126,$127,$128,$129,$130,$131,$132,$133,$134,$135,$136,$137,$138,$139,$140,$141,$142,$143,$144,$145,$146,$147,$148,$149,$150,$151,$152,$153,$154,$155,$156,$157,$158,$159,$160,$161,$162,$163,$164,$165,$166,$167,$168,$169,$170,$171,$172,$173,$174,$175,$176,$177,$178,$179,$180,$181,$182,$183,$184,$185,$186,$187,$188,$189,$190,$191,$192,$193,$194,$195,$196,$197,$198,$199,$200,$201,$202,$203,$204,$205,$206,$207,$208,$209,$210,$211,$212,$213,$214,$215,$216,$217,$218,$219,$220,$221,$222,$223,$224,$225,$226,$227,$228,$229,$230,$231,$232,$233,$234,$235,$236,$237,$238,$239,$240)<br>      GROUP BY "collectionId", tf.timeframe<br>      ON CONFLICT ("collectionId", timeframe) DO UPDATE<br>        SET "itemCount" = EXCLUDED."itemCount", "updatedAt" = NOW()<br>``` |     |     |
| 47,411 min 6% | 72,317 ms | 39,336 civitai |
| ```pgsql<br>UPDATE "PostMetric" pm<br>          SET "ageGroup" = 'Day'::"MetricTimeframe"<br>          WHERE pm."postId" IN (759032,2912565,3155850,6476841,7350536,8321992,8907410,12080218,12426285,12673892,13901127,14039610,14332037,14336546,14409845,14497921,14540086,14965428,15328046,15407490,15524372,15529916,15530050,15530127,15565971,15565997,15566649,15566745,15566857,15568833,15572397,15572479,15579447,15589006,15594520,15598386,15612358,15619423,15621513,15708886,15745943,15745988,15746013,15752696,15752705,15793756,15793846,15812196,15857976,15887069,15932577,15934677,15934723,15937770,15939660,15959895,15961673,15965199,16030917,16047597,16069695,16133563,16173519,16280067,16292534,16313784,16341317,16342000,16374006,16391358,16393863,16421818,16444855,16459515,16485994,16500391,16530751,16537358,16566183,16619327,16698322,16726263,16818757,16928880,16944777,16989006,17000053,17010216,17057701,17068370,17087491,17115595,17117382,17127058,17146723,17173317,17178877,17195528,17202255,17204357,17207311,17227191,17246680,17264111,17276617,17278616,17300610,17310401,17368224,17387150,17387656,17391501,17401248,17423466,17429588,17430833,17439899,17440286,17441072,17442937,17451414,17458943,17493722,17501460,17517927,17523480,17533491,17571091,17577328,17587504,17638571,17647957,17648039,17648060,17648257,17760086,17768047,17771058,17815313,17829229,17841283,17843854,17845475,17845558,17852889,17852970,17853180,17853260,17863569,17883173,17886816,17889056,17896508,17912641,17913118,17913462,17941626,17955943,17956235,17979670,17979700,17988527,17991251,17991427,18007641,18018406,18019473,18020123,18054092,18075289,18104530,18120013,18140329,18140354,18140383,18140424,18140611,18145158,18145169,18150489,18162407,18166937,18172527,18176077,18190606,18198588,18202763,18224825,18243121,18245581,18255683,18259714,18262564,18267366,18268474,18280561,18280901,18283067,18283139,18293483,18295506,18307870,18307884,18315094,18342367,18347458,18347480,18347504,18347531,18356043,18356063,18356148,18356232,18364678,18364969,18365031,18365061,18371150,18371354,18373927,18380770,18380818,18380872,18380930,18383393,18402549,18412130,18422667,18423048,18423415,18445937,18483417,18496163,18500558,18500591,18500633,18500694,18500762,18500809,18500939,18515985,18524717,18524727,18524735,18524745,18539030,18539884,18539935,18542819,18543306,18544064,18545556,18546264,18563983,18567352,18569181,18570487,18582281,18583559,18591272,18605003,18624596,18624793,18626221,18626573,18626983,18627202,18627369,18630317,18630739,18630774,18630793,18630919,18630961,18631040,18631480,18642784,18643254,18651538,18651552,18651559,18651564,18651573,18654803,18654820,18654825,18654834,18654840,18654851,18654858,18654866,18654871,18654883,18654890,18655699,18664746,18668289,18668676,18672553,18674116,18683514,18683585,18687502,18697460,18705458,18706173,18713840,18718476,18722020,18748902,18759143,18761498,18768953,18769114,18770621,18773172,18775978,18776961,18783443,18807548,18811397,18815064,18817058,18820231,18826116,18829943,18830789,18831583,18836036,18836548,18841367,18842327,18848567,18850493,18852634,18858691,18867197,18867774,18869192,18871817,18880410,18882842,18883322,18901982,18904969,18909281,18912764,18913410,18915139,18928936,18929503,18934654,18937155,18939990,18940591,18942694,18947212,18947945,18948618,18948645,18948653,18949711,18954901,18957467,18957788,18957810,18957829,18957848,18957865,18959298,18959543,18962850,18966604,18966912,18969818,18972877,18976758,18977910,18977933,18978266,18978685,18978875,18979017,18979186,18979539,18982423,18982676,18998437,19002889,19003863,19004181,19005931,19006068,19006143,19007195,19007219,19008271,19015271,19016442,19016443,19016444,19016447,19016451,19016453,19016617,19031559,19032295,19033328,19038424,19044224,19044815,19048535,19048731,19049269,19049848,19050481,19054002,19054698,19054766,19054778,19054865,19054880,19054896,19054912,19055094,19055215,19055230,19055255,19055266,19055321,19055353,19055396,19055408,19055425,19055603,19055727,19057333,19058938,19059133,19059730,19059825,19061001,19061339,19061499,19062705,19063437,19065944,19066298,19067075,19067358,19067402,19067569,19070580,19070689,19070786,19070837,19071017,19071060,19071182,19077438,19082166,19084761,19085357,19089251,19091426,19091746,19092450,19092708,19092906,19093110,19098080,19098129,19098232,19098429,19098691,19098893,19100025,19100053,19100068,19106737,19107971,19108367,19109008,19109249,19109289,19112143,19112517,19115627,19118605,19120547,19128030,19130124,19130166,19130297,19132042,19135659,19137268,19138372,19138387,19138423,19138436,19138454,19138478,19138491,19138533,19138547,19138575,19138655,19138744,19138896,19138915,19138965,19138979,19138996,19139020,19139037,19139047,19139088,19139112,19139203,19142846,19148268,19150249,19151415,19159118,19161868,19161887,19163700,19165733,19165841,19166002,19166033,19166063,19166998,19167577,19167624,19167732,19168336,19169707,19171300,19178213,19178398,19185538,19186011,19186932,19186990,19187375,19188555,19190926,19195527,19199992,19200108,19201148,19203356,19209813,19209979,19210730,19211274,19211641,19212639,19215408,19215438,19231363,19231645,19233247,19236778,19239075,19239930,19242506,19243657,19245097,19245167,19245277,19246542,19246869,19249197,19249301,19250315,19250400,19250537,19250640,19252354,19256729,19258022,19258305,19259024,19259057,19259176,19260347,19260395,19261670,19264645,19266046,19267847,19268641,19270213,19273083,19274927,19274952,19276413,19277014,19277679,19277683,19279164,19279180,19280276,19281032,19281042,19281142,19281200,19281257,19281698,19282618,19282883,19283032,19283967,19285749,19287867,19295952,19298533,19298947,19299747,19300289,19301349,19301741,19302222,19303542,19305293,19305912,19306526,19306552,19307691,19309388,19309998,19310100,19310711,19310743,19310762,19310774,19310791,19310810,19310984,19310995,19311008,19311751,19315057,19316290,19317726,19317733,19317737,19317740,19317741,19319488,19319544,19322866,19324323,19325151,19328024,19330109,19332068,19333301,19333383,19333440,19333510,19333549,19334863,19336813,19337501,19338317,19341566,19341731,19342206,19343089,19343091,19344380,19344899,19345620,19345735,19346333,19346402,19346444,19346455,19346460,19346900,19347377,19347461,19348146,19349886,19350934,19352977,19353057,19353537,19354007,19354050,19354919,19357345,19359479,19361532,19361888,19361963,19362092,19362126,19362265,19363359,19363449,19363823,19363903,19363981,19365978,19366617,19367118,19368183,19368796,19368806,19368867,19368876,19370471,19372345,19373090,19374339,19375641,19375800,19376389,19380924,19380928,19381432,19382390,19382423,19382696,19382705,19383595,19384987,19385210,19385677,19385756,19386058,19386276,19386620,19386645,19387166,19387393,19387505,19387997,19388015,19388035,19388854,19389827,19391042,19391084,19391189,19391292,19391922,19392990,19393244,19393325,19393339,19393966,19393993,19394127,19394201,19394230,19394232,19394416,19394616,19394647,19394695,19394742,19394788,19395072,19395120,19395198,19395207,19395423,19395757,19396655,19398658,19401657,19402405,19402757,19402946,19403006,19403067,19403517,19403653,19404040,19404178,19404264,19404338,19406181,19406348,19406530,19407308,19408793,19409144,19410522,19411155,19411216,19411251,19415012,19415237,19416280,19417731,19418385,19420909,19422428,19422839,19423098,19423147,19423578,19423795,19424076,19424823,19425559,19427175,19428336,19430551,19431309,19431422,19431732,19431764,19431793,19431859,19434651,19435441,19435806,19436679,19436752,19436948,19437048,19437295,19437346,19437618,19437746,19437843,19438005,19438114,19438264,19438396,19438400,19438551,19438563,19438597,19438611,19438656,19439129,19442484,19442972,19444281,19444813,19445217,19445515,19445971,19447430,19447731,19448634,19448791,19448957,19448962,19448969,19448984,19449675,19450242,19450277,19450537,19450619,19451135,19451530,19452594,19452600,19452623,19452630,19452638,19452647,19452660,19452675,19452685,19452696,19452704,19452736,19453121,19453168,19453195,19453232,19453282,19453914,19453915,19453918,19453934,19455062,19455515,19455941,19456884,19457025,19457083,19458045,19458194,19460410,19460438,19461650,19462248,19463034,19463829,19463922,19463924,19463947,19464052,19464239,19464362,19465103,19465255,19465364,19466139,19466434,19466442,19466726,19467144,19467253,19467303,19468680,19469050,19469269,19470357,19470584,19471343,19471734,19471839,19472282,19472521,19473496,19473797,19474267,19474411,19475165,19475192,19475238,19475260,19475334,19475386,19475417,19475461,19475557,19475607,19475646,19475713,19475743,19475924,19475976,19476008,19476035,19476213,19476375,19477608,19478929,19479487,19480146,19480816,19481157,19481551,19482046,19484063,19485176,19485468,19486252,19486731,19486741,19486766,19487022,19487064,19487485,19487580,19487594,19487613,19487672,19487739,19487750,19487761,19487792,19488576,19488706,19488925,19488994,19489514,19489620,19489717,19490095,19490555,19491456,19492373,19493366,19493679,19494414,19494653,19494686,19495113,19495706,19496485,19497025,19497800,19500102,19500834,19501009,19501277,19501340,19501573,19501642,19501744,19501875,19502012,19502127,19502209,19502235,19502313,19502333,19503126,19503617,19504036,19504206,19504396,19504441,19505612,19505996,19506084,19506180,19506185,19507482,19508544,19508801,19509100,19509163,19509423,19509718,19509882,19509963,19510002,19510112,19510506,19512120,19512149,19512175,19512213,19512312,19512338,19512386,19512449,19513412,19513658,19513765,19514161,19514318,19514489,19515163,19515538,19515605,19515615,19515813,19516637,19516643,19516651,19516666,19516877,19516953,19517082,19517200,19517748,19517877,19518000,19518882,19518913,19518947,19520069,19520084,19520261,19520294,19520310,19520669,19520859,19520981,19521498,19521539,19521585,19521620,19521723,19521750,19521917,19522049,19522071,19522168,19522174,19522239,19522245,19522260,19522377,19522440,19522443,19522567,19522632,19522780,19522818,19522915,19522942,1<br>``` |     |     |
| 1 min < 0.1% | 64,695 ms | 1 civitai |
| ```pgsql<br>-- update collection item metrics<br>      INSERT INTO "CollectionMetric" ("collectionId", timeframe, "itemCount")<br>      SELECT<br>        "collectionId",<br>        tf.timeframe,<br>        <br>    SUM(CASE<br>      <br>      WHEN tf.timeframe = $1 THEN $2<br>      WHEN tf.timeframe = $3 AND "createdAt" > (NOW() - interval $4) THEN $5<br>      WHEN tf.timeframe = $6 AND "createdAt" > (NOW() - interval $7) THEN $8<br>      WHEN tf.timeframe = $9 AND "createdAt" > (NOW() - interval $10) THEN $11<br>      WHEN tf.timeframe = $12 AND "createdAt" > (NOW() - interval $13) THEN $14<br>      ELSE $15<br>    END)<br>   as "itemCount"<br>      FROM "CollectionItem"<br>      CROSS JOIN (SELECT unnest(enum_range($16::"MetricTimeframe")) AS timeframe) tf<br>      WHERE "collectionId" IN ($17,$18,$19,$20,$21,$22,$23,$24,$25,$26,$27,$28,$29,$30,$31,$32,$33,$34,$35,$36,$37,$38,$39,$40,$41,$42,$43,$44,$45,$46,$47,$48,$49,$50,$51,$52,$53,$54,$55,$56,$57,$58,$59,$60,$61,$62,$63,$64,$65,$66,$67,$68,$69,$70,$71,$72,$73,$74,$75,$76,$77,$78,$79,$80,$81,$82,$83,$84,$85,$86,$87,$88,$89,$90,$91,$92,$93,$94,$95,$96,$97,$98,$99,$100,$101,$102,$103,$104,$105,$106,$107,$108,$109,$110,$111,$112,$113,$114,$115,$116,$117,$118,$119,$120,$121,$122,$123,$124,$125,$126,$127,$128,$129,$130,$131,$132,$133,$134,$135,$136,$137,$138,$139,$140,$141,$142,$143,$144,$145,$146,$147,$148,$149,$150,$151,$152,$153,$154,$155,$156,$157,$158,$159,$160,$161,$162,$163,$164,$165,$166,$167,$168,$169,$170,$171,$172,$173,$174,$175,$176,$177,$178,$179,$180,$181,$182,$183,$184,$185,$186,$187,$188,$189,$190,$191,$192,$193,$194,$195,$196,$197,$198,$199,$200,$201,$202,$203,$204,$205,$206,$207,$208,$209,$210,$211,$212,$213,$214,$215,$216,$217,$218,$219,$220,$221,$222,$223,$224,$225,$226,$227,$228,$229,$230,$231,$232,$233)<br>      GROUP BY "collectionId", tf.timeframe<br>      ON CONFLICT ("collectionId", timeframe) DO UPDATE<br>        SET "itemCount" = EXCLUDED."itemCount", "updatedAt" = NOW()<br>``` |     |     |
| 754 min 0.1% | 59,153 ms | 765 civitai |
| ```pgsql<br>SELECT<br>            "createdAt",<br>            "userId",<br>            id,<br>            "nsfw",<br>            "nsfwLevel",<br>            "type"<br>          FROM "Image"<br>          WHERE id BETWEEN $1 AND $2 AND nsfw != $3<br>```<br><br>`Covered by index on (id) Rows: 80814816 Row progression: 80814816, 8081482  Row estimates - id (BETWEEN): 8081482 - nsfw (<>): 64651853  Existing indexes - id PRIMARY - CREATE INDEX "Image_nsfwLevelLocked" ON public."Image" USING btree ("nsfwLevelLocked") WHERE "nsfwLevelLocked" - blockedFor" WHERE ("needsReview" = 'newUser'::text) AND ("blockedFor" IS NOT NULL) AND ("blockedFor" <> 'AiNotVerified'::text - createdAt, id WHERE (meta IS NOT NULL) AND (meta ? 'civitaiResources'::text) - createdAt") INCLUDE ("userId, nsfw - createdAt") INCLUDE (i - id WHERE (ingestion = 'Blocked'::"ImageIngestionStatus") AND ("blockedFor" <> 'AiNotVerified'::text) - ingestion - needsReview" WHERE "needsReview" IS NOT NUL - postId HASH - scannedAt - type - updatedAt") INCLUDE (i - url HASH - userId, createdAt - userId, id - userId, postId` |     |     |
